<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
	<c:set var="remoteHtml" value="yes" />
	<%@ include file="../module/meta.jsp" %>
	<script src="${PUBLIC_PATH}/public/upload/uploadfile.js"></script>
	<link media="all" type="text/css" rel="stylesheet" href="${PUBLIC_PATH}/public/css/remote5.5.css"/>
	<script type="text/javascript" src="${PUBLIC_PATH}/public/player/videoplayer.js"></script>
	<script>
		var JAVA_V = '5.5';
		var MID = "${mid}",
            UID =  "remote_admin_${mid}",
            MAIN_SPEAK = "${classInfo.clsClassroomId}",
            PMS = "${classInfo.pmsServer}",
            publishModule = "${meetConfig['meet.publishModule']}",
        	//coco参数
            IP = "${meetConfig['meet.cocoServerHost']}",
            PORT = "${meetConfig['meet.cocoServerPort']}",
			BACKIP = "${meetConfig['meet.cocoServerBackHost']}",
			EXTRA_STR = "${meetConfig['meet.cipher']}",
            DEBUG = "${param.debug}";
		
		var MOVIE_HEAD_UP = false,
    		MOVIE_FOOT_UP = false,
            DIRECTOR_MODE = 0;
            
        var WEN_UPLOAD_HOST = "${classInfo.fileUploadUrl}";
        var m = WEN_UPLOAD_HOST.match(/^https?\:\/+[^\/]+/);
        if (m && m[0]) {
        	WEN_UPLOAD_HOST = m[0];
        }
       
        //WEN_UPLOAD_HOST = "http://172.17.53.96:88/"
        var WEN_UPLOAD_URL = WEN_UPLOAD_HOST + '/Upload?mid=${mid}';
        var PMS_REMOTE_URL = "${classInfo.pmsRemoteUrl}";
        var IS_HAND_DIRECTED = "${classInfo.handDirectedSwitch}"; //摇杆设备
        
		var SCHOOL_NAME = '${classInfo.schoolName}',//学校
			TEACHER_NAME = '${classInfo.realName}',//主讲教师
			CLASSLEVEL = '${classInfo.classlevelName}',//年级
			SUBJECT = '${classInfo.subjectName}',//学科
			RECEIVE_NAMES = '${receiveNamesStr}';
		
		var RECEIVE_ROOMS = [];
		<c:forEach items="${receiveList}" var="receive" varStatus="receiveSta">
			if ("${receive.clsClassroomId}" != UID) {
				RECEIVE_ROOMS.push({
					clsClassroomId: "${receive.clsClassroomId}",
					schoolName: "${receive.schoolName}",
					isMain: false
				});
			}
		</c:forEach>
		
        //var WEN_UPLOAD_HOST = "http://192.168.1.112:88/";
        PMS = "${meetConfig['meet.pmsServerHost']}",
    	DMC = "${meetConfig['meet.dmsServerHost']}";
    	<c:if test="${meetConfig['meet.streamingServerType'] == 'PMS'}">
    		DMC = "";  
    	</c:if>
    	
    	var IMG_PATTERN = ["jpg","png","ico","bmp","gif","tif","pcx","tga"],
			MOVIE_PATTERN = ["mp4","3gp","avi","mkv","wmv","mpg","vob","flv","swf","mov"];
	</script>
    <script type="text/javascript" src="${PUBLIC_PATH}/public/stream/stream.js"></script>
	<script type="text/javascript" src="${PUBLIC_PATH}/public/js/util.js"></script>
	<script>
		var moreMenu = {
			isOver: false,
			finishClass2: function () {
				this.isOver = true;
				var dialog = Win.confirm({
					title: "提示",
					html: '当前课堂已结束。',
					mask: true
				}, function () {
					window.opener = null;
					window.open('', '_self', '');
					window.close();
				}, false);
				$(dialog.dom).find('.dialog_close').hide();
			}
		};
		var $doc = $(document);
		var noop = function () {};
		var director = (function (undefined) {
			var slice = Array.prototype.slice;
			var module = {};
			var _data = {};
			var waitDialog;
			var getTimeStr = function (n) {
				if(0==n) return "--:--:--";
				var ary = [];
				var mi = 60;
				var hh = mi*60;
				ary[0] = Math.floor(n/hh);
				ary[0] = ary[0]>=10?ary[0]:"0"+ary[0];
				ary[1] = Math.floor((n%hh)/mi);
				ary[1] = ary[1]>=10?ary[1]:"0"+ary[1];
				ary[2] = n%mi;
				ary[2] = ary[2]>=10?ary[2]:"0"+ary[2];
				return ary.join(':');
			};
			var FREE_NOTICE = false;
			return {
				data: _data,
				getData: function () {
					return _data;
				},
				getModule: function () {
					return module;
				},
				loginNotify: function (from) {},//上线
				//掉线linkDown
				logoutNotify2: function () {
					var dialog = Win.confirm({
						id : "otherLoginDialog",
						mask: true,
						html: "帐号已于别处登录，点击【确定】退出远程导播。"
					}, function () {
						window.opener = null;
						window.open('', '_self', '');
						window.close();
					}, false);
					$(dialog.dom).find('.dialog_close').hide();
				},
				logoutNotify: function (from) {//下线logout
					if (from == MAIN_SPEAK) {
						if (!moreMenu.isOver) {
							waitDialog = Win.alert({
								id: "dialogRemoteAlert",
								html: '与远程课堂终端失去连接，请耐心等待。',
								mask: true,
								width: 320
							}, 0);
							$(waitDialog.dom).find('.dialog_close').hide();
						}
					} else if (from == UID) {
						var dialog = Win.confirm({
							id : "otherLoginDialog",
							mask: true,
							html: "帐号已于别处登录，点击【确定】退出远程导播。"
						}, function () {
							window.opener = null;
							window.open('', '_self', '');
							window.close();
						}, false);
						$(dialog.dom).find('.dialog_close').hide();
					}
				},
				getRecordMode: function () {
					return _data.recordMode;
				},
				isMain: function () {
					return false;
				},
				free: function (freeDiskSpace, freeRecordTime, isInitPage) {
					isInitPage = isInitPage || false;
					var freeDiskStr;
					if (freeDiskSpace < 1024) {
						freeDiskStr = (freeDiskSpace>>0) + 'm';
					} else {
						freeDiskStr = (((freeDiskSpace/1024*10)>>0)/10) + 'G';
					}
					$('#freeDiskSpace').html(freeDiskStr);
					$('#freeRecordTime').html(getTimeStr(freeRecordTime));
					
					var freeSpace = freeDiskSpace; //录制磁盘空间剩余
					var recordState = director.module.recordState;
					switch(true){
						case freeSpace <= 200 :
							if (FREE_NOTICE != 1) {
								FREE_NOTICE = 1;
								Win.notice("<span class='orange'>磁盘空间过低，系统将暂停录制，请及时清理磁盘空间,保证空间2G以上。</span>", 5000);
								if (recordState.state == 'on') {
									if (isInitPage) {
										recordState.stop();
									} else {
										recordState.next();
									}
								}
								recordState.disabled();
							}
							break;
						case freeSpace > 200 && freeSpace <= 500 :
							recordState.enabled();
							if (FREE_NOTICE != 2) {
								FREE_NOTICE = 2;
								Win.notice("<span class='orange'>磁盘空间已不足500M，如不清理，将影响录制。</span>", 5000);
							}
							break;
						case freeSpace > 500 && freeSpace <= 1024 :
							recordState.enabled();
							if (FREE_NOTICE != 3) {
								FREE_NOTICE = 3;
								Win.notice("<span class='orange'>磁盘空间已不足1G，请注意清理。</span>", 5000);
							}
							break;
						default: 
							FREE_NOTICE = false;
							recordState.enabled();
					}
				},
				addModule: function (key, obj) {
					//this[key] = obj;
					module[key] = obj;
					if (obj.extendDirector) {
						obj.extendDirector(this);
					}
				},
				getMaxIndex: function (map) {
					var max = 0;
					for (var index in map) {
						if (index * 1 > max) {
							max = index * 1;
						}
					}
					return max+1;
				},
				rushScene: function () {
					$('#sceneSelect').jsSelect('val', _data.sceneData.sceneSelectIndex);
					if (_data.sceneData.sceneSelectIndex >= 0 ) {
						$('.scene-box .turnOn-btn').addClass('selected');
						$('#sceneSelect').jsSelect('disable2');
					}
				},
				pageMode: function (p) {
					_data.pageMode = p;
				},
				initPage: function (type, json) {//页面初始化，只读取页面需要的数据，弹出框的时候，再获得详细数据
					console.log(type,json)
					var _type=0, camera=0, action=0, number=0;
					$.extend(_data, json);
					if (type == 'logo' || type == 'subtitle' || type == 'headend') {
						var m = module[type];
						if (m.initPage) {
							m.initPage(_data);
						}
					} else if (type == "videoBar" || type == "picMode") {
						var m = module[type];
						if (m.initPage) {
							m.initPage(_data);
						}
						if("videoBar"==type) {
							var modeObj = {manual: 0,auto: 1,autoManual: 23};
							number = slotControl.getLight(_type, camera, modeObj[json.videoBarData.directorMode]);
							slotControl.setDirectorMode(number);

							var videoMap = json.videoBarData.map;
							var video = videoMap[json.videoBarData.videoControl];
							_type = 8, action = 22;
							if("教师跟踪"==video.title) {
								camera = 0;
							} else if("学生跟踪"==video.title) {
								camera = 1;
							} else if("教师板书"==video.title) {
								camera = 2;
							}
							number = slotControl.getLight(_type, camera, action);
							slotControl.setDirectorMode(number);

							video = videoMap[json.videoBarData.videoMain];
							_type = 1, action = 22;
							if("教师跟踪"==video.title) {
								camera = 0;
							} else if("教师全景"==video.title) {
								camera = 1;
							} else if("学生跟踪"==video.title) {
								camera = 2;
							} else if("学生全景"==video.title) {
								camera = 3;
							} else if("教师板书"==video.title) {
								camera = 4;
							} else if("vga"==video.title) {
								camera = 5;
							} 
							number = slotControl.getLight(_type, camera, action);
							slotControl.setDirectorMode(number);
						} else {
							number = slotControl.getLight(6, json.picModeData.picModeUseIndex, 22);
							slotControl.setDirectorMode(number);
						}

					} else if (type == "shortCut") {
						module.shortCut.initPage(_data);
					} else {
						if (type == 'all' && _data.sceneData) {
							this.rushScene();
							number = slotControl.getLight(4, json.recordState, 22);
							slotControl.setDirectorMode(number);
							number = slotControl.getLight(5, json.recordMode, 22);
							slotControl.setDirectorMode(number);
							number = slotControl.getLight(7, -1==json.sceneData.sceneUseIndex?5:json.sceneData.sceneUseIndex, 22);
							slotControl.setDirectorMode(number);
						}
						for (var type in module) {
							if (type == 'logo' || type == 'subtitle' || type == 'headend' || type == "videoBar" || type == "picMode" || type == "shortCut") {
							} else {
								if (module[type].initPage) {
									module[type].initPage(_data);
								}
							}
						}
						if (waitDialog) {
							waitDialog.close();
						}
						$('#recordMode').jsSelect('val', _data.recordMode);
						director.pageMode(_data.pageMode);
						//director.setMode(_data.lessonMode);
					}
					//录制模式
				},
				checkNumIpt: function (elm) {
					var val = $.trim(elm.value);
					if (!/^\d+$/.test(val)) {
						if (val !== "") {
							Win.alert({
								width: '350',
								html: elm.getAttribute('data-msg')||"请填写整数！"
							});
						}
						elm.value = 0;
						return false;
					} else  {
						elm.value = parseInt(val, 10);
					}
					return true;
				},
				init: function () {
					console.log('director.module init');
					
					COCO.cocoEvent.add('linkDown',function(json){
						director.logoutNotify2();
					});
					COCO.cocoEvent.add('loginNotify', function(json){
						var message = json.message;
						director.loginNotify(message.from);
					});
					COCO.cocoEvent.add('logoutNotify', function(json){
						var message = json.message;
						director.logoutNotify(message.from);
					});
					COCO.cocoEvent.add('receiveAll', function(json){
						var data = json.message;
						if (data.api == "remoteGet") {
							remote.get(data.opt, data.uid, data.needCallback, JSON.parse(decodeURIComponent(data.data)));
						}
					});
					
					director.module = module;
					director.module.recordState.changeListener.add(function (state) {
						if (state != 'on') {
							FREE_NOTICE = false;
						}
					})
					var self = this;
					$('#recordMode').jsSelect({
						data: [
							{text:'电影模式', value: 0},
							{text:'资源模式', value: 1},
							{text:'电影模式+资源模式', value: 2}
						],
						change: function (obj) {
							arr = null;
							//console.log('change', obj);
							if (!self.isRecord()) {
								var flag = false;
								if (obj.value == 0) {
									flag = true;
								} else {
									if (_data.recordMode == 0) {
										var arr = [];
										var videoBarData = director.getData().videoBarData;
										var map = videoBarData.map;
										for(var i in map) {
											if(map[i].videoRecord) arr.push(~~i);
										}
										flag = true;
									}
								}
								_data.recordMode = obj.value;
								remote.call("changeRecordMode", obj.value, flag, arr, function(res) {
									var type=5, action=22, number=0;
									number = slotControl.getLight(type, obj.value, action);
									slotControl.setDirectorMode(number);
								});
							}
						}
					});
					
					$('.main-video-cover').on('click', function () {
						var $elm = $(this);
						if ($elm.hasClass('main-video-cover-left')) {
							remote.call("f2fVideoHighlight", 0);
						} else {
							remote.call("f2fVideoHighlight", 1);
						}
					});
					
					var turnOnModel = function (obj) {
						var key = obj.key;
						var text = obj.text;
						var cmd = obj.cmd;
						var val = obj.val;
						
						var data = _data[key + 'Data'];
						if (self.isRecord() && (key == 'head' || key == 'end')) {
							Win.alert((key == 'head' ? '录制状态不能修改片头。' :'录制状态不能修改片尾。' ));
							return;
						}
						var oldUse = data[key + 'UseIndex'];
						if (oldUse == val) {//不启用
							//$elm.removeClass('selected');
							data[key + 'SelectIndex'] = data[key + 'UseIndex'] = -1;
							remote.call(cmd, -1);
							obj.unSet();
						} else {
							if (val == -2) {
								Win.alert('请选择要启用的' + text + '。');
								return;
							}
							data[key + 'SelectIndex'] = data[key + 'UseIndex'] = val;
							if (key == 'subtitle') {
								director.module.subtitle.updateSubtitle(true);
							}
							(function(key) {
								remote.call(cmd, val, function(res) {
									if(key=="head" || key=="end") {
										if(1==res) obj.set();
										else {
											data[key + 'UseIndex'] = -1;
											Win.alert("您插入的"+text+"视频文件与主课堂录制的视频文件"+(0==res?"格式":"分辨率")+"不一至！");
										}
									} else {
										obj.set();
									}
								});
							})(key);
						}
					}
					$doc.on('click', '.dialog-turnOn-btn', function () {
						var $elm = $(this);
						var $box = $elm.parents('.pop-tab-box');
						var val = $elm.parents('tr').attr('data-key');
						var key = $box.attr('data-model');
						var $btn = $('.turnOn-btn[data-model=' + key + ']');
						
						turnOnModel({
							key: key,
							text: $box.attr('data-text'),
							cmd: $box.attr('data-remote'),
							val: val,
							unSet: function () {
								$elm.removeClass('selected');
								$btn.removeClass('selected');
								$('#' + key + 'Select').jsSelect('enable2');
								if (key == 'head' || key == 'end') {
									director.module.headend.rushSelect(key);
								} else {
									director.module[key].rushSelect();
								}
								console.log('key', key);
								//self.rushSelect();
							},
							set: function () {
								$box.find('.dialog-turnOn-btn.selected').removeClass('selected');
								$elm.addClass('selected');
								$btn.addClass('selected');
								$('#' + key + 'Select').jsSelect('disable2');
								if (key == 'head' || key == 'end') {
									director.module.headend.rushSelect(key);
								} else {
									director.module[key].rushSelect();
								}
								console.log('key', key);
								//self.rushSelect();
							}
						})
					});	
					
					$('.turnOn-btn').on('click', function () {
						var $elm = $(this);
						if ($elm.hasClass('daobo-btn')) return;
						if ($elm.hasClass('shortCut-btn')) return;
						
						var $box = $elm;
						var val = $elm.siblings('.jsSelect-warper').jsSelect('val').value;
						var key = $box.attr('data-model');
						var $btn = $elm;
						if("scene"==key && -1==val) {
							slotControl.setDirectorMode(33);
						}
						
						turnOnModel({
							key: key,
							text: $box.attr('data-text'),
							cmd: $box.attr('data-remote'),
							val: val,
							unSet: function () {
								$btn.removeClass('selected');
								$('#' + key + 'Select').jsSelect('enable2');
								if("scene"==key) {
									slotControl.setDirectorMode(33);
								}
							},
							set: function () {
								$btn.addClass('selected');
								$('#' + key + 'Select').jsSelect('disable2');
								if("scene"==key) {
									var number = slotControl.getLight(7, val, 22);
									slotControl.setDirectorMode(number);
								}
							}
						})
					});	
					/*
					$doc.on('change', ".number-ipt", function () {
						self.checkNumIpt(this);
					});
					$('#subtitleSelect,#logoSelect,#endSelect,#headSelect').on('change', function () {
						var model = this.id.replace('Select', '');
						var $btn = $('.turnOn-btn[data-model="' + model + '"]');
						if ($btn.hasClass('selected')) {
							Win.alert('启用状态不能变更');
							this.value = _data[model + 'Data'][model + 'UseIndex'];
						}
					});*/
					$('#subtitleSelect,#logoSelect,#endSelect,#headSelect,#sceneSelect').jsSelect({
						data: [
							{text:'请选择', value: -2}
						],
						beforeChange: function (obj) {
							var model = this.$elm[0].id.replace('Select', '');
							if (model == 'end' || model == 'head') {
								var map = _data[model + 'Data'].map;
								var obj = map[obj.value];
								if (obj && obj.state == 0) {
									if (model == 'head') {
										Win.alert(obj.title + '片头还在生成中');
										return false;
									} else {
										Win.alert(obj.title + '片尾还在生成中');
										return false;
									}
								}
							}
						},
						change: function (obj) {
							var model = this.$elm[0].id.replace('Select', '');
							var oldVal = _data[model + 'Data'][model + 'UseIndex'];
							if (oldVal != -2 && oldVal != -1) {
								//Win.alert('启用状态不能变更');
								$('#' + model + 'Select').jsSelect('val', oldVal);
							} else {
								_data[model + 'Data'][model + 'SelectIndex'] = obj.value;
							}
						},
						clickSelect: function () {
							var $elm = this.$elm;
							if ($elm.hasClass('disable')) {
								var msg = $elm.attr('data-disableMsg');
								if (msg) {
									Win.alert(msg);
								}
								return false;
							} else {
								var model = $elm[0].id.replace('Select', '');
								var oldVal = _data[model + 'Data'][model + 'UseIndex'];
								if (oldVal != -2 && oldVal != -1) {
									var map = {
										head: '片头',
										end: '片尾',
										logo: '台标',
										subtitle: '字幕',
										scene: '特效'
									};
									Win.alert({
										id : "dialogAlert",
										width: 360,
										html: '修改' + map[model] + '前，请先关闭当前启用的' + map[model] + '。'
									})
									return false;
								}
							}
						}
					});
					$('#sceneSelect').jsSelect('extendOpt', {
						data: [
							{text: '请选择', value: "-1"},
							{text: '淡入淡出', value: "4"},
							{text: '左上', value: "0"},
							{text: '左下', value: "2"},
							{text: '右上', value: "1"},
							{text: '右下', value: "3"}
						]
					});
					//
					waitDialog = Win.alert({
						id: "dialogRemoteAlert",
						html: '正在连接远程课堂终端，请耐心等待。',
						mask: true,
						width: 300
					}, 0);
					$(waitDialog.dom).find('.dialog_close').hide();
					$('#masker').height($(window).height());
					
					/*
					waitDialog.close();
					console.log('initPage122222222');
					this.initPage('logo', {logoData: {
						logoUseIndex: -1,
						map: {}
					}});
					this.initPage('headend', {headData: {
						headUseIndex: -1,
						map: {}
					}});
					this.initPage('headend', {endData: {
						endUseIndex: -1,
						map: {}
					}});
					this.initPage('subtitle', {
						subtitleData: {
							subtitleUseIndex: -1,
							map: {}
						}
					});
					this.initPage("videoBar" ,{"videoBarData":{"directorMode":"autoManual","map":{"1":{
						"videoBitrate":1000,
						"title":"教师跟踪",
						"pizEnable":true,
						"videoRecord":true,
						"presetNum":8,isReceiver: false
					},
					"2":{
						"videoBitrate":1000,
						"title":"VGA",
						"pizEnable":false,
						"videoRecord":false,
						"presetNum":0,isReceiver: false
					},
					"3":{"videoBitrate":1000,"title":"学生跟踪","pizEnable":true,"videoRecord":false,"presetNum":0,isReceiver: true},
					"4":{"videoBitrate":1000,"title":"教师板书","pizEnable":false,"videoRecord":false,"presetNum":0,isReceiver: true},
					"5":{"videoBitrate":1000,"title":"教师全景","pizEnable":false,"videoRecord":false,"presetNum":0,isReceiver: true}
				},"videoMain":1,'videoControl': 1}});
					this.initPage("picMode" ,
						{"picModeData":{
							"popMap":{
							"1":[3,5,2,4],
							"2":[1,3,4,5],
							"3":[1,2,4,5],
							"4":[3,2,1,5],
							"5":[3,4,1,2]
						},
						"pipNum":5,
						pipPos: 1,
						"picModeUseIndex":1,
						"pipMap":{"1":[3,4,2,5],"2":[1,-1,-1,4],"3":[1,-1,-1,2],"4":[1,-1,-1,2],"5":[2,-1,-1,1]},
						popPos: 1,
						"popNum":5}}
					);		
					this.initPage("all" ,{
						"freeDiskSpace":77774,
						"lessonMode":0,
						"freeRecordTime":77774,
						"recordMode":0,
						lessonMode:0,"recordTime":0,"recordState":2, 
						sceneData: {sceneSelectIndex: 2, sceneUseIndex: 2}
					});*/
					
					setTimeout(function() {
						remote.call("getDirectorMode", function(val) {
							DIRECTOR_MODE = val;
						});
					}, 5000);
				}
			};				
		})();
    </script>
</head>
<body >
	<c:if test="${classInfo.handDirectedSwitch == 'Y'}">
		<%@ include file="module/slot.jsp" %>
	</c:if>
	<%@ include file="../module/cocoWrap.jsp" %> 
	<div id="pageWarper">
		<header>
			<div class="head-inner">
				<h1>
					<img src="${PUBLIC_PATH}/public/img/main/logo.png" width="120" />
					<b>直录播教室导播系统</b>
				</h1>
				<a href="javascript:;" class="btn btnGreen exit">退出</a>
			</div>
		</header>
		<div class="wrap">
			<div class="clearfix">
				<div class="left-cont">
					<div class="main-video"></div>
					<div class="main-video-cover main-video-cover-left"></div>
					<div class="main-video-cover main-video-cover-right"></div>
				</div>
				<div class="right-cont">
					<ul class="video-bar clearfix"></ul>
				</div>
			</div>
			<ul class="operate-bar clearfix">
				<div class="operate-col1">
					<div class="config-box mode-box">
						录制模式
						<div id="recordMode" data-remote="recordMode" class="jsSelect-warper" data-disableMsg="录制状态不能修改录制模式。"></div><a class="icon-set recordMode-btn" href="javascript:;"></a>
					</div>
					<div class="config-box headend-box ">
						<div>片头/片尾<a href="javascript:;" class="icon-set headend-btn"></a></div>
						<div>
							片头名称
							<div id="headSelect" class="jsSelect-warper" data-disableMsg="录制状态不能修改片头。"></div>
							<a value="开启" href="javascript:;" class="turnOn-btn" data-model="head" data-text="片头" data-remote="movieHead">片头</a>
						</div>
						<div>
							片尾名称
							<div id="endSelect" class="jsSelect-warper" data-disableMsg="录制状态不能修改片尾。"></div>
							<a value="开启" href="javascript:;" class="turnOn-btn" data-model="end" data-text="片尾" data-remote="movieEnd">片尾</a>
						</div>
					</div>
					<div class="config-box control-box ">
						录制控制
						<a href="javascript:;" class="copy" title="点击开始录制"></a>
						<a href="javascript:;" class="stop" title="点击停止录制"></a>
						<span id="recordTime"></span>
						<div class="control-box-warp" style="display: none;"></div>
					</div>
				</div>
				<div class="operate-col2">
					<div class="config-box logo-box ">
						台标
						<div id="logoSelect" class="jsSelect-warper"></div>
						<a href="javascript:;" value="开启" class="turnOn-btn" data-model="logo" data-text="台标" data-remote="logo">台标</a>
						<a href="javascript:;" class="icon-set logo-btn"></a>
					</div>
					<div class="config-box scene-box ">
						特效
						<div id="sceneSelect" class="jsSelect-warper"></div>
						<a value="开启" class="turnOn-btn" data-model="scene" data-text="特效" data-remote="sceneStyle" href="javascript:;">特效</a>
					</div>
					<div class="config-box subtitle-box ">				
						字幕
						<div id="subtitleSelect" class="jsSelect-warper"></div>
						<a class="turnOn-btn" data-model="subtitle" data-remote="subtitle" data-text="字幕" href="javascript:;">开启</a>
						<a href="javascript:;" class="icon-set subtitle-btn"></a>
					</div>
					<div class="config-box daobo-box clearfix">
						<div class="daobo-text">导播模式</div>						
						<a class="turnOn-btn daobo-btn" data-mode="manual" href="javascript:;" >手动</a>
						<a class="turnOn-btn daobo-btn" data-mode="auto"  href="javascript:;">自动</a>
						<a class="turnOn-btn daobo-btn" data-mode="autoManual" href="javascript:;" >半自动</a>
					</div>
				</div>
				<div class="config-box picmode-box operate-col3 ">
					画面模式<a href="javascript:;" class="icon-set picmode-btn"></a>
					<div class="picmode-bar clearfix">
						<div data-modeindex="0" class="box fl"><span class="check"></span></div>
						<div data-modeindex="1" class="box fr"><span class="check"></span><img src="${PUBLIC_PATH}/public/img/remote/picmode1.png"></div>
						<div data-modeindex="2" class="box fl"><span class="check"></span><img src="${PUBLIC_PATH}/public/img/remote/picmode2.png"></div>
						<div data-modeindex="3" class="box fr"><span class="check"></span><img src="${PUBLIC_PATH}/public/img/remote/picmode3.png"></div>
					</div>
				</div>
				<div class="camera-preset-box config-box operate-col4">
					预置位
					<div class="btn-cont">
						<a href="javascript:;" class="type1">1</a>
						<a href="javascript:;" class="type1">2</a>
						<a href="javascript:;" class="type1">3</a>
						<a href="javascript:;" class="type1">4</a>
						<a href="javascript:;" class="type1">5</a>
						<a href="javascript:;" class="type1">6</a>
						<a href="javascript:;" class="type1">7</a>
						<a href="javascript:;" class="type1">8</a>
						<a href="javascript:;" class="type1 disable">9</a>
					</div>
				</div>
				<div class="camera-control-box config-box operate-col5 ">
					摄像机控制
					<div style="margin-top:10px;">变焦 +
							<span class="range rangeNearFar">
								<span class="range-value"></span>
								<span class="ranged-btn"></span>
							</span>
						-
					</div>
					<div>变倍 +
							<span class="range rangeInOut">
								<span class="range-value"></span>
								<span class="ranged-btn"></span>
							</span>
						-
					</div>
					<div class="direct-key">
						<a ondragstart="return false" class="up" data-action="up" href="javascript:;"></a>
						<a ondragstart="return false" class="right" data-action="right" href="javascript:;"></a>
						<a ondragstart="return false" class="down" data-action="down" href="javascript:;"></a>
						<a ondragstart="return false" class="left" data-action="left" href="javascript:;"></a>
					</div>
				</div>
				<div class="operate-col6">
					<div class="config-box theme-box clearfix">
						<div>学校：<span title="${classInfo.schoolName}">${classInfo.schoolName}</span></div>
						<div>教师：<span title="${classInfo.realName}">${classInfo.realName}</span></div>
						<div>年级：<span >${classInfo.classlevelName}</span></div>
						<div>学科：<span>${classInfo.subjectName}</span></div>
					</div>
					<div class="config-box recRoom-box ">
						<div>接收教室1：</div>
						<div>接收教室2：</div>
						<div>接收教室3：</div>
					</div>
					<div class="config-box sys-stat-box ">
						<div>磁盘剩余空间：<span id="freeDiskSpace"></span></div>
						<div>可录制时间：<span id="freeRecordTime"></span></div>
						<a class="turnOn-btn shortCut-btn"  href="javascript:;">快捷键设置</a>
					</div>
				</div>
			</ul>
		</div>
	</div>
	<%@ include file="module/tmpl.jsp" %>
<script>
	(function () {
		var html = [];
		$.each(RECEIVE_ROOMS, function (index) {
			html.push('<div>接收教室' + (index + 1) + '：' + this.schoolName + '</div>')
		});
		$('.recRoom-box').html(html.join(''));
		var $win = $(window);
		var $body = $('body');					
		var cssName = function (name) {
			var prefixes = ['-ms-','-moz-', '-webkit-', '-khtml-', '-o-', ''];
			var rcap = /-([a-z])/g;
			var capfn = function($0,$1) {
				return $1.toUpperCase(); 
			}; 
			var target = document.documentElement.style;
			var test;
			for (var i=0, l=prefixes.length; i < l; i++) { 
				test = (prefixes[i] + name).replace(rcap, capfn); 
				if (test in target) { 
					return test; 
				}
			}
			if(UA.isIE){
				return (UA.isIElt9) ? 'zoom' : 'msTransform';
			}
			return null;
		};
		var transitionName = cssName('transform');
		window.PAGE_WARPER_ZOOM = 1;
		var pageWarper = document.getElementById('pageWarper');
		var $pageWarper = $(pageWarper);
		var _size = function () {
			var winX = $win.width(), winY =  $win.height();
			if (winX <= 1388 || winY <= 670) {
				PAGE_WARPER_ZOOM = 1;
			} else {
				if ((winX-40)/1368 > (winY-40)/670) {
					PAGE_WARPER_ZOOM = ((winY-40)/670);
				} else {
					PAGE_WARPER_ZOOM = ((winX-40)/1368);
				}
			}
			if (UA.isChrome) {
				if (PAGE_WARPER_ZOOM > 1.07) PAGE_WARPER_ZOOM = 1.07;
			}
			if (transitionName == 'zoom') {
				$body.css('padding-top', (winY-670*PAGE_WARPER_ZOOM)/2);
				if (PAGE_WARPER_ZOOM == 1) {
					$pageWarper.css('marginLeft', "auto");
				} else {
					$pageWarper.css('marginLeft', (winX - 1368*PAGE_WARPER_ZOOM)/2);
				}
				
				pageWarper.style[transitionName] = "" + PAGE_WARPER_ZOOM;
			} else {
				if (PAGE_WARPER_ZOOM == 1) {
					$body.css('padding-top', 0);
				} else {
					$body.css('padding-top', (winY-670)/2);
				}
				pageWarper.style[transitionName] = "scale(" + PAGE_WARPER_ZOOM + ")";
			}
		}
		_size();
		$win.on('resize', _size);
	})();
	(function (undefine) {
		var $record, $stop, $recordTime, $warp;
		var timeId;
		var stateMap = ['on', 'pause', 'stop'];
		var getTimeStr = function (n) {
			if(0==n) return "--:--:--";
			var ary = [];
			var mi = 60;
			var hh = mi*60;
			ary[0] = Math.floor(n/hh);
			ary[0] = ary[0]>=10?ary[0]:"0"+ary[0];
			ary[1] = Math.floor((n%hh)/mi);
			ary[1] = ary[1]>=10?ary[1]:"0"+ary[1];
			ary[2] = n%mi;
			ary[2] = ary[2]>=10?ary[2]:"0"+ary[2];
			return ary.join(':');
		}
		window.NEXT_RECORD_STATE = 500;
		var recordState = {
			state: 'stop',
			isDisabled: false,
			time: 0,
			changeListener: new util.Listener(),
			extendDirector: function (director) {
				var self = this;
				director.isRecord = function () {
					return self.state != 'stop';
				};
				director.recordStateChange = function (json) {
					self.initPage(json);
				};
			},
			disabled: function () {
				if (!this.isDisabled) {
					this.isDisabled = true;
					$record.addClass('disabled');
					$record.attr('_title', $record.attr('title'));
					$record.attr('title', "请先清理硬盘，保证2G以上");
				}
			},
			enabled: function () {
				if (this.isDisabled) {
					this.isDisabled = false;
					$record.removeClass('disabled');
					$record.attr('title', $record.attr('_title'));
					$record.attr('_title', null);
				}
			},
			html: function (flag) {
				var self = this;
				var state = self.state;
				
				if (state=='on') {
					$record[0].className = 'copy ing';
					$stop[0].className = 'stop enable';
					$record.attr('title', "正在录制中,点击暂停");
				} else if (state=='pause') {
					$record[0].className = 'copy pause';
					$stop[0].className = 'stop enable';
					$record.attr('title', "已暂停,点击继续");
				} else if (state=='stop') {
					if (this.isDisabled) {
						$record[0].className = 'copy disabled';
						$stop[0].className = 'stop';
						$record.attr('_title', "点击开始录制");
					} else {
						$record[0].className = 'copy';
						$stop[0].className = 'stop';
						$record.attr('title', "点击开始录制");
					}
				}
				
				if (state!='stop') {//录制中
					$('#recordMode').jsSelect('disable');
					$('#headSelect').jsSelect('disable');
					$('#endSelect').jsSelect('disable');
				} else {
					$('#recordMode').jsSelect('enable');
					$('#headSelect').jsSelect('enable');
					$('#endSelect').jsSelect('enable');
				}
				
				if (state=='on') {
					if (!timeId) {
						timeId = setInterval(function () {
							if (self.state != 'stop' && self.state != 'pause') {
								$recordTime.html(getTimeStr(++self.time));
							}
						}, 1000);
					}
				} else {
					if (timeId) {
						clearInterval(timeId);
						timeId = 0;
					}
				}
				
				$warp.show();
				
				setTimeout(function () {$warp.hide();}, NEXT_RECORD_STATE);
				
				if(flag) $recordTime.html(getTimeStr(self.time));
			},
			next: function () {
				var self = this;
				if (self.isDisabled) return;
				var state = self.state;
				var nextState = "";
				
				if (state=='stop') {
					nextState = 'on';
				} else if (state=='on') {
					nextState = 'pause';
				} else if (state=='pause') {
					nextState = 'on';
				}
				
				(function(nextState) {
					remote.call('recordState', stateMap.indexOf(nextState), function(res) {
						if(-1==res) {
							Win.alert("片头或片尾正在生成中，不允许录制！");
							return ;
						}
						self.state = nextState;
						self.changeListener.fire(nextState);
						self.html();
					});
				})(nextState);
			},
			stop: function () {
				var self = this;
				if("stop"==self.state) return ;
				var nextState = "stop";
				
				!function(nextState) {
					remote.call("recordState", stateMap.indexOf(nextState), function(res) {
						if(-1==res) return ;
						self.state = nextState;
						self.time = 0;
						self.changeListener.fire(nextState);
						self.html();
					});
				}(nextState);
			},
			init: function () {
				var self = this;
				$recordTime = $('#recordTime');
				$warp = $('.control-box-warp');
				
				$record = $('.control-box .copy').on('click', function () {
					self.next();
				});
				
				$stop = $('.control-box .stop').on('click', function () {
					self.stop();
				});
			},
			initPage: function (json) {
				this.time = json.recordTime || 0;
				this.state = stateMap[json.recordState];
				this.html(true);
				director.free(json.freeDiskSpace, json.freeRecordTime);
			}
		}
		recordState.init();
		director.addModule('recordState', recordState);
	})();
</script>
<script>
(function (undefine) {
	var tmpl = util.template($('#videoBarTmpl').html());
	var dialogTmp = util.template($('#videoDialogTmpl').html());
	var videoBarData = {map: {}};
	var directorData;
	var $bar = $('.video-bar');
	var rSpeakersParams = {
		url : PMS_REMOTE_URL,
		file : "",
		fileName : "",
		buffer : 0,
		bufferMax : 0,
		fullimg : "",
		bgcolor : "0xaac7e7",
		playType: -1, //-2:优先直播；-1：直播；0以上：录播
		//receiveType: 'all'; //"audio":只接收音频；"video":只接收视频；"all"
		watermark: 0 //水印位置：1，2，3，4 ；默认0：无
	};
	var setVideoBarSpeakers = false;
	var speakerMap = {};
	var speakerMain;
	var $leftBox = $('.camera-preset-box');
	var $rightBox = $('.camera-control-box');
	var $type1s = $leftBox.find('.type1');
	
	var getVideoParams = window.getVideoParams = function(){//add by wqq 用于辅助调试代码
		var dataObj = {
				videoBarData : videoBarData,
				rSpeakersParams : rSpeakersParams,
				speakerMap : speakerMap,
				speakerMain : speakerMain
		}
		return dataObj;
	};
	
	var setCameraControl = function (main) {
		
		rangControlMap.far.pos(29).move('min');
		rangControlMap.out.pos(29).move('min');
		rangControlMap.near.pos(29).move('min');
		rangControlMap['in'].pos(29).move('min');
		directControlMap.left.up();
		directControlMap.right.up();
		directControlMap.up.up();
		directControlMap.down.up();
		
		if (main) {
			$bar.find('.video-bar-record').removeClass('ing');
			$bar.find('.video-bar-item[data-index=' + main + '] .video-bar-record').addClass('ing');
			videoBarData.videoControl = main;
		}
		
		
		if (director.getPicMode() == 3) {//对话模式
			$type1s.addClass('disable');
			$rightBox.addClass('disable');	
			return;
		} 
		if (videoBarData.directorMode == 'auto') {//自动
			$leftBox.addClass('disable');
			$rightBox.addClass('disable');
		} else if (videoBarData.directorMode == 'manual') {//手动
			var obj = videoBarData.map[videoBarData.videoControl] || {presetNum : 0, pizEnable: false};
			$leftBox.removeClass('disable');
			if (obj.presetNum == 0) {
				$type1s.addClass('disable');
			} else {
				$type1s.removeClass('disable');
				$leftBox.find('.type1:gt(' + (obj.presetNum-1) + ')').addClass('disable');
			}
			if (obj.pizEnable) {
				$rightBox.removeClass('disable');
			} else {
				$rightBox.addClass('disable');
			}
		} else if (videoBarData.directorMode == 'autoManual') {//半自动
			$type1s.addClass('disable');
			$rightBox.addClass('disable');
			if(0==DIRECTOR_MODE) return ;
			var obj = videoBarData.map[videoBarData.videoControl] || {presetNum : 0, pizEnable: false};
			$leftBox.removeClass('disable');
			if(obj.presetNum == 0) {
				$type1s.addClass("disable");
			} else {
				$type1s.removeClass("disable");
				$leftBox.find('.type1:gt(' + (obj.presetNum-1) + ')').addClass('disable');
			}
			if (obj.pizEnable) {
				$rightBox.removeClass('disable');
			} else {
				$rightBox.addClass('disable');
			}
		}
	};
	var directControl = function ($elm, actionKey) {
		var $btn = $elm;
		var lastState = 'up';
		return {
			init: function () {
				var self = this;
				$btn.on("mousedown", function(){
					self.down();
				}).on("mouseup mouseleave", function(){
					self.up();
				});
				return this;
			},
			down: function () {
				if ($rightBox.hasClass('disable')) return;
				if (lastState != 'down') {
					lastState = 'down';
					$btn.addClass("selected")
					remote.call('videoMove', videoBarData.videoControl, actionKey, 'down');
				}
			},
			up: function () {
				if ($rightBox.hasClass('disable')) return;
				if (lastState != 'up') {
					lastState = 'up';
					$btn.removeClass("selected")
					remote.call('videoMove', videoBarData.videoControl, actionKey, 'up');
				}
			}		
		}
	};
	
	
	var rangControl = function ($elm, action) {
		var $rang = $elm;
		var $rangBtn = $rang.find(".ranged-btn");
		var $rangVal = $rang.find(".range-value");
		var actionMap = action;
		var lastState = 'min';
		return {
			init: function () {
				var self = this;
				var $doc = $(document);
				$rangBtn.on("mousedown", function(e){
					if ($rightBox.hasClass('disable')) return;
					var offsetLeft = this.offsetLeft,
						startX = e.pageX;
					lastState = "min";
					$doc.on('mousemove', function(e){
						var endX = e.pageX;
						var posX = offsetLeft + endX - startX;
						var state;
						if (posX >= -5 && posX <= 60) {
							if (posX < 29) {
								self.move('left');
							} else if (posX > 29) {
								self.move('right');
							}
							self.pos(posX);
						}
					}).one('mouseup', function(){
						$doc.off('mousemove');
						self.pos(29);
						self.move('min'); 
					});
				});
				return this;
			},
			pos: function (posX) {
				$rangBtn.css("left", posX).siblings(".range-value").css("width" , posX + $rangBtn[0].clientWidth/2);
				return this;
			},
			move: function (state) {
				console.log("lastState", action, lastState, state);
				if (lastState != state) {
					if (lastState != "min") {
						remote.call('videoMove', videoBarData.videoControl, actionMap[lastState], 'up');
					}
					if (state != 'min') {
						remote.call('videoMove', videoBarData.videoControl, actionMap[state], 'down');
					}
				}
				lastState = state;
				return this;
			}		
		}
	};
	var rangControlMap = {};
	var directControlMap = {};
	
	var subVieosSize;
	var videoBar = window.videoBar = {
		getVideoBarData : function (){
			return videoBarData;
		},
		bindKeyProxy: function () {
			var directTab = ['left', 'up', 'right', 'down'];
			$doc.on('keydown', function (e) {
				var nodeName = e.target.nodeName.toLowerCase();
				if (nodeName == 'input' || nodeName == 'textarea') {
					return;
				}
				if ($('#masker').length > 0) return;//有弹出层时，不响应键盘操作
				
				var keyCode = e.which;
				switch (true) {
					case 49 <= keyCode && keyCode <= 54:
						$('.video-bar-item:eq(' + (keyCode-49) + ') .video-bar-item-title').click();	
						break;
					case 97 <= keyCode && keyCode <= 105:
						$('.camera-preset-box .type1:eq(' + (keyCode-97) + ')').click();
						break;
					case 37 <= keyCode && keyCode <= 40:
						directControlMap[directTab[keyCode-37]].down();
						break;
					case keyCode == 173:
						director.videoMove('near');
						break;
					case keyCode == 61:
						director.videoMove('far');
						break;
					case keyCode == 219:
						director.videoMove('in');
						break;
					case keyCode == 221:
						director.videoMove('out');
						break;
					case keyCode == 32:
						var $ipts = $('.daobo-box .daobo-btn');
						if ($($ipts[0]).hasClass('selected')) {
							$ipts[1].click();
						} else {
							$ipts[0].click();
						}
						break;
				}					
			}).on('keyup', function (e) {
				var nodeName = e.target.nodeName.toLowerCase();
				if (nodeName == 'input' || nodeName == 'textarea') {
					return;
				}
				if ($('#masker').length > 0) return;
				var keyCode = e.which;
				switch (true) {
					case 37 <= keyCode && keyCode <= 40:
						directControlMap[directTab[keyCode-37]].up();
						break;
					case keyCode == 173 || keyCode == 61:
						director.videoMove('minNearFar')
						break;
					case keyCode == 219 || keyCode == 221:
						director.videoMove('minInOut')
						break;
				}
			})
		},
		extendDirector: function (director) {
			director.directorModeChange = function (mode) {
				$('.daobo-btn').removeClass('selected');
				$('.daobo-btn[data-mode="' + mode + '"]').addClass('selected')
				videoBarData.directorMode = mode;
				setCameraControl();
			};
			director.setCameraControl = setCameraControl;
			director.directControlMap = directControlMap;
			director.changeMainVideo = function (main) {
				//console.log('director.changeMainVideo', main);
				if (videoBarData.videoMain != main) {
					videoBarData.videoMain = main;
					$('.video-bar-item[data-index="' + main + '"]').addClass('selected').siblings().removeClass('selected');
					setCameraControl(main);
				}
			};
			director.BitrateChange = function (map) {
				var bMap = videoBarData.map;
				for (var key in map) {
					if (bMap[key]) {
						bMap[key].videoBitrate = map[key].videoBitrate;
					}
				}
				//console.log(videoBarData);
			};
			director.videoMove = function (action) {
				if ($rightBox.hasClass('disable')) return;
				if (action == 'minNearFar') {
					rangControlMap.far.pos(29).move('min');
				} else if (action == 'minInOut') {
					rangControlMap.out.pos(29).move('min');
				} else if ( action == 'near' || action == 'in'){
					rangControlMap[action].pos(10).move('left');
				} else {
					rangControlMap[action].pos(48).move('right');
				}
			};
			director.videoClickFollow = function ($elm, e) {
				var $item = $elm.parents('.video-bar-item');
				var index = $item.attr('data-index');
				if ( index && videoBarData.directorMode == "manual" && director.getPicMode() != 3) {
					if (videoBarData.map[index] && videoBarData.map[index].isReceiver) {
						return;
					}
					var offset = $elm.offset();
					var pos = [e.pageX - offset.left, e.pageY - offset.top];
					remote.call("SetSubViewCenter", index, Math.round(pos[0]), Math.round(pos[1]), Math.round(subVieosSize[0]*PAGE_WARPER_ZOOM), Math.round(subVieosSize[1]*PAGE_WARPER_ZOOM));
				}
			};
			
			director.pageMode = function (mode) {
				directorData.pageMode = mode;
			};
			/*
			director.directorModeLessonModeCheck = function () {
				if (directorData.lessonMode == 2) {
					Win.alert({
						id : "dialogAlert",
						width: 400,
						html: '主讲教师正在使用【互动模式】授课<br>在退出该模式之前，手动导播功能暂时无法使用'
					});
					return false;
				}
				return true;
			}*/
			
			director.directorDaoBoCheck = function () {
				if (directorData.pageMode == "myVideo") {
					Win.alert({
						id : "dialogAlert",
						width: 400,
						html: '主讲教师正在使用【我的视频】授课<br>在退出该模式之前，无法切换导播模式'
					});
					return false;
				}
				return true;
			}
			
		},
		init: function () {
			var self = this;
			$bar.html(tmpl({data: videoBarData}));
			speakerMain = new Speaker($('.main-video')[0], false,  "${PUBLIC_PATH}/public/stream/streamPlayer.swf", rSpeakersParams);
			speakerMain.streamEvent.add('onLinkup', function(){
				//speakerMain.play.setReady();
				speakerMain.play("class_" + MAIN_SPEAK  + "_u_" + MID + "_0__main");
			});
			
			var changeControlVideo = function (index) {
				setCameraControl(index);
			}
			
			var $smallVideoCover = $('.small-video-cover');
			subVieosSize = [$smallVideoCover.width(), $smallVideoCover.height()];
			//摇杆设备
			$bar/*.on('click', '.small-video-cover', function (e) {
				director.videoClickFollow($elm, e);
				
				var $elm = $(this);
				var $item = $elm.parents('.video-bar-item');
				var index = $item.attr('data-index');
				if ( index && videoBarData.directorMode == "manual" && director.getPicMode() != 3) {
					var offset = $elm.offset();
					var pos = [e.pageX - offset.left, e.pageY - offset.top];
					remote.call("SetSubViewCenter", index, Math.round(pos[0]), Math.round(pos[1]), Math.round(subVieosSize[0]*PAGE_WARPER_ZOOM), Math.round(subVieosSize[1]*PAGE_WARPER_ZOOM));
				}
				
			})*/.on('click', '.video-bar-item-title', function (e) {
				var $elm = $(this);
				var $item = $elm.parents('.video-bar-item');
				var index = $item.attr('data-index');
				//手动模式中
				if (director.getPicMode() == 3 && index) {
					remote.call("f2fVideoIndex", index);
					return;
				}
				
				
				if (!$item.hasClass('selected') && index && (videoBarData.directorMode == "manual" ||  videoBarData.directorMode == "autoManual")) {
					var title = $.trim(videoBarData.map[index].title||'').toLowerCase();
					remote.call('videoMain', index, title == 'vga');
					director.changeMainVideo(index);					
				}	
			});
			
			//导播模式
			$('.daobo-box').on('click', '.daobo-btn', function () {
				
				var $elm = $(this);
				if (!$elm.hasClass('selected')) {
					if (director.directorDaoBoCheck()) {
						var modeObj = {manual:0,auto:1,autoManual:23};
						$elm.addClass('selected').siblings('.daobo-btn').removeClass('selected');
						var mode = $elm.attr('data-mode');
						remote.call('directorMode', mode, function(res) {
							var number = slotControl.getLight(0, 0, modeObj[mode]);
							slotControl.setDirectorMode(number);
						});
						videoBarData.directorMode = mode;
						setCameraControl();
					}
				}
			});
			rangControlMap.near = rangControlMap.far = rangControl($('.rangeNearFar'), {left: 'near', right: 'far'}).init();
			rangControlMap['in'] = rangControlMap.out = rangControl($('.rangeInOut'), {left: 'in', right: 'out'}).init();
						 
			
			//摄像机控制
			$bar.on('click', '.video-bar-record', function () {
				
				changeControlVideo($(this).parents('.video-bar-item').attr('data-index'));
			});
			
			//切换预置位
			$(".camera-preset-box").on("click", ".type1", function(){
				var $elm = $(this);
				if ($leftBox.hasClass('disable') || $elm.hasClass('disable')) return;
				if ($elm.hasClass('selected')) return;
				$elm.addClass("selected").siblings().removeClass("selected");
				remote.call('presetPosition', videoBarData.videoControl, $elm.html()*1-1);
			}).on("mousedown", ".type1", function(){
				var $elm = $(this);
				if ($leftBox.hasClass('disable') || $elm.hasClass('disable')) return;
				$elm.addClass('down');
			}).on("mouseup mouseleave", ".type1", function(){
				var $elm = $(this);
				if ($leftBox.hasClass('disable') || $elm.hasClass('disable')) return;
				$elm.removeClass('down');
			});
			
			$('.direct-key a').each(function () {
				var $elm = $(this), actionKey = $elm.attr('data-action');
				directControlMap[actionKey] = directControl($elm, actionKey).init();
			});
			
			//this.bindKeyProxy();
			director.addModule('videoBar', this);
		},
		initPage: function (json) {
			//console.log('videoBar initPage', json);
			if (json.videoBarData === undefine) return;
			videoBarData = json.videoBarData;
			directorData = json;
			//导播模式
			$('.daobo-box .daobo-btn').removeClass('selected');
			$('.daobo-box .daobo-btn[data-mode="' + videoBarData.directorMode + '"]').addClass('selected');
			setCameraControl();
			
			var map = videoBarData.map;
			if (!setVideoBarSpeakers) {
				setVideoBarSpeakers = true;
				//***如果，在重连再次显示的时候，不该进行相关的处理
				
				var roomIndex = 0;
				for (var index = 1; index < 10; index++) {
					var obj = map[index];
					if (obj) {
						if (obj.isReceiver) {
							if (!RECEIVE_ROOMS[roomIndex]) {
								map[index] = null;
								continue;
							} else {
								roomIndex++;
							}
						}
					}
				}
	
				$bar.html(tmpl({data: videoBarData}));
				var roomIndex = 0;
				$bar.find(".video-bar-item").each(function () {
					var $box = $(this);
					var index = $box.attr('data-index');
					var obj = map[index];
					if (obj) {
						var streamName;
						if (obj.isReceiver) {
							streamName = "class_" + MAIN_SPEAK + "_u_" + MID + "_" + RECEIVE_ROOMS[roomIndex].clsClassroomId;
							obj.title = RECEIVE_ROOMS[roomIndex].schoolName;
							$box.find('.video-bar-item-title').html(obj.title);
							$box.find('.video-bar-item-title')[0].title = obj.title;
							roomIndex++;
							var rParams = extendCopy({}, rSpeakersParams);
							var run = function (url) {
								rParams.url = url;
								speakerMap[index] = new Speaker($box.find('.small-video-warp')[0], false,  "${PUBLIC_PATH}/public/stream/streamPlayer.swf", rParams);
								speakerMap[index].streamEvent.add('onLinkup', function(){
									console.log(streamName);
									//speakerMap[index].play.setReady();
									speakerMap[index].play(streamName);
								});
							}
							if (window.DMC) { //DMC获取流服务器地址
								$jsonp(DMC, {
									method : "play",
									stream : streamName,
									domain : window.DMC_DOMAIN || "",
									confid : MID
								}, function (url) {
									if (!url) {
										Win.alert("DMC服务器错误！");
									} else {
										run(url);
									}
								});
							} else {
								run(PMS);
							}
							
						} else {
							streamName = "class_" + MAIN_SPEAK  + "_u_" + MID + "_" + index + "__main";
							rSpeakersParams.url = PMS_REMOTE_URL;
							speakerMap[index] = new Speaker($box.find('.small-video-warp')[0], false,  "${PUBLIC_PATH}/public/stream/streamPlayer.swf", rSpeakersParams);
							speakerMap[index].streamEvent.add('onLinkup', function(){
								console.log(streamName);
								//speakerMap[index].play.setReady();
								speakerMap[index].play(streamName);
							});
						}
						
					}
				});
			} else {
				$bar.find(".video-bar-item").each(function (index) {
					var $box = $(this);
					var index = $box.attr('data-index');
					var obj = map[index];
					if (obj) {
						if (index == videoBarData.videoMain) {
							$box.addClass('selected');
						} else {
							$box.removeClass('selected');
						}
						if (index == videoBarData.videoControl) {
							$box.find('.video-bar-record').addClass('ing');
						} else {
							$box.find('.video-bar-record').removeClass('ing');
						}
						/*
						if (obj.videoRecord) {
							$box.find('.video-bar-record').addClass('ing');
						} else {
							$box.find('.video-bar-record').removeClass('ing');
						}*/
						$box.attr('data-index', index);
						//speakerMap[index].play();
					} else {
						$box.removeClass('selected');
						//$box.find('.video-bar-record').removeClass('ing');
						$box.attr('data-index', null);
					}
				});
				speakerMain.play("class_" + MAIN_SPEAK  + "_u_" + MID + "_0__main");
			}
		}
	};
	videoBar.init();
})();
</script>
<script>
(function (undefine) {
	
	var addEvent = (function(window, undefined) {        
	    var _eventCompat = function(event) {
	        var type = event.type;
	        if (type == 'DOMMouseScroll' || type == 'mousewheel') {
	            event.delta = (event.wheelDelta) ? event.wheelDelta / 120 : -(event.detail || 0) / 3;
	        }
	        if (event.srcElement && !event.target) {
	            event.target = event.srcElement;    
	        }
	        if (!event.preventDefault && event.returnValue !== undefined) {
	            event.preventDefault = function() {
	                event.returnValue = false;
	            };
	        }
	        return event;
	    };
	    if (window.addEventListener) {
	        return function(el, type, fn, capture) {
	            if (type === "mousewheel" && document.mozHidden !== undefined) {
	                type = "DOMMouseScroll";
	            }
	            el.addEventListener(type, function(event) {
	                fn.call(this, _eventCompat(event));
	            }, capture || false);
	        }
	    } else if (window.attachEvent) {
	        return function(el, type, fn, capture) {
	            el.attachEvent("on" + type, function(event) {
	                event = event || window.event;
	                fn.call(el, _eventCompat(event));    
	            });
	        }
	    }
	    return function() {};    
	})(window);  
		
	var shortCutTmpl = util.template($('#shortCutTmpl').html());
	var defaultConfig = {"clickFollow":"click0","clickMoveLeft":"dblclick0","clickMoveRight":"dblclick2","wheelFar":"mousewheelup","wheelNear":"mousewheeldown"};
	var SHORT_CONFIG = defaultConfig;
	var key2name = {};
	var action = {};
	var shortCut = {
		openConfigDlg: function () {
			var dialog = Win.open({
				title : "快捷键设置",
				width: 1100,
				mask: true,
				html : shortCutTmpl({data: SHORT_CONFIG})
			});
			var $dialog = $(dialog.dom).addClass('noMenu2');
			var map = {};
			var map2 = {};
			for (var key in SHORT_CONFIG) {
				map[SHORT_CONFIG[key]] = key;
				map2[key] = SHORT_CONFIG[key];
			}
			$dialog.on('keyup', 'input', function () {
				var e = arguments[0] || window.event;
				var name = this.name;
				if (this.value == ' ') {
					this.value = '<space>';
				}
				
				if("SC_rangeFar"==name||"SC_rangeNear"==name||"SC_rangeOut"==name||"SC_rangeIn"==name||"SC_moveUp"==name||"SC_moveDown"==name||"SC_moveLeft"==name||"SC_moveRight"==name) {
					var keyCode = e.keyCode;
					switch(keyCode) {
					case 37:
						this.value = "<left>";
						break;
					case 38:
						this.value = "<up>";
						break;
					case 39:
						this.value = "<right>";
						break;
					case 40:
						this.value = "<down>";
						break;
					}
				}
				
				var val = ('key' + this.value).toLowerCase();
				if (val != 'key') {
					if (map[val] && map[val] != name) {
						Win.alert('按键设置冲突', 1000);
						this.value = "";
						return;
					} else {
						map[val] = name;
						map2[name] = val;
					}
				} else {
					delete map[map2[name]];
					delete map2[name];
				}
			});
			var $clickMoveLeft = $('#clickMoveLeft');
			var $clickMoveRight = $('#clickMoveRight');
			var $wheelFar = $('#wheelFar');
			var $wheelNear = $('#wheelNear');
			
			var wheelMap = {
				'mousewheelup': '<option value="mousewheelup">滚轮向前</option><option value="mousewheeldown"  selected>滚轮向后</option>',
				'mousewheeldown': '<option value="mousewheelup" selected >滚轮向前</option><option value="mousewheeldown">滚轮向后</option>'
			};
			
			$dialog.on('change', 'select', function () {
				if (this.name == 'clickFollow') {
					if (this.value == 'click0') {
						$clickMoveLeft.html('<option value="dblclick0">左键双击</option>');
						$clickMoveRight.html('<option value="dblclick2">右键双击</option>');
					} else {
						$clickMoveLeft.html('<option value="click0">左键单击</option>');
						$clickMoveRight.html('<option value="click2">右键单击</option>');
					}
				}
				
				if (this.name == 'wheelFar') {
					$wheelNear.html(wheelMap[this.value]);
				} else if (this.name == 'wheelNear') {
					$wheelFar.html(wheelMap[this.value]);
				}
			})
			
			$dialog.on('click', '.dialog-add-btn', function () {
				$dialog.find('select').each(function () {
					map2[this.name] = this.value;
				})
				SHORT_CONFIG = map2;
				shortCut.save();
				dialog.close();
				//保存
			});
		},
		setName: function () {
			key2name = {};
			console.log(JSON.stringify(SHORT_CONFIG));
			for (var key in SHORT_CONFIG) {
				key2name[SHORT_CONFIG[key]] = key;
			}
		},
		fire: function (key, type, $elm, event) {
			console.log(key2name[key]);
			if (action[key2name[key]]) {
				action[key2name[key]]($elm, event);
			}
		},
		setActions: function () {
			var keyPress = function (fn1, fn2) {
				var timeId = 0;
				var _fn2 = function () {
					console.log('_fn2($elm, event)');
					timeId = 0;
				};
				return function ($elm, event) {
					clearTimeout(timeId);
					if (timeId == 0) {
						console.log('fn1($elm, event)');
						fn1($elm, event);
					}
					if (fn2) {
						timeId = setTimeout(function () {
							console.log('fn2($elm, event)');
							fn2($elm, event);
							timeId = 0;
						}, timeId == 0?550: 100);
					} else {
						timeId = setTimeout(_fn2, timeId == 0?550: 100);
					}
				}
			};
			
			var videoControl = function (fn) {
				return function ($elm, event) {
					var $item = $elm.parents('.video-bar-item');
					var index = $item.attr('data-index');
					var $control = $item.find('.video-bar-record');
					if ($control.length >0 && index) {
						if (!$control.hasClass('ing'))
							$control.click();
						fn($elm, event);
					}
				}
			};
			
			
			var minfarNear = function () {
				console.log("director.videoMove('minInOut')");
				director.videoMove('minInOut');
			};
			
			var timeIdWheelFar = 0;
			action.wheelFar = videoControl(function ($elm) {
				clearTimeout(timeIdWheelFar);
				timeIdWheelFar = setTimeout(minfarNear, 300);
				director.videoMove('in');
			});
			
			var timeIdWheelNear = 0;
			action.wheelNear = videoControl(function ($elm) {
				clearTimeout(timeIdWheelFar);
				timeIdWheelFar = setTimeout(minfarNear, 300);
				director.videoMove('out');
			});
			

			action.clickMoveLeft = keyPress(videoControl(function ($elm) {
				director.directControlMap.left.down();
			}), function () {
				director.directControlMap.left.up();
			});
			
			
			action.clickMoveRight = keyPress(videoControl(function ($elm) {
				director.directControlMap.right.down();
			}), function () {
				director.directControlMap.right.up();
			});
			
			action.clickFollow = director.videoClickFollow;
			
			action.SC_daobo = keyPress(function () {
				var $btn = $('.daobo-btn')
				var index = $('.daobo-btn.selected').index() - 1;
				var len = $btn.length;
				$('.daobo-btn').eq((index + 1)%len).click();
			})
			
			action.SC_recordStart = keyPress(function () {
				var recordState = director.module.recordState;
				recordState.next();
			})
			
			action.SC_recordStop = keyPress(function () {
				var recordState = director.module.recordState;
				if (recordState.state != 'stop') {
					recordState.stop();
				}
			})
			
			action.SC_rangeFar = keyPress(function () {
				director.videoMove('far');
			}, function () {
				director.videoMove('minNearFar');
			})
			
			action.SC_rangeNear = keyPress(function () {
				director.videoMove('near');
			}, function () {
				director.videoMove('minNearFar');
			})
			
			action.SC_rangeOut = keyPress(function () {
				director.videoMove('out');
			}, function () {
				director.videoMove('minInOut');
			})
			
			
			action.SC_rangeIn = keyPress(function () {
				director.videoMove('in');
			}, function () {
				director.videoMove('minInOut');
			})
			
			
			action.SC_moveUp = keyPress(function () {
				director.directControlMap.up.down();
			}, function () {
				director.directControlMap.up.up();
			})
			
			action.SC_moveDown = keyPress(function () {
				director.directControlMap.down.down();
			}, function () {
				director.directControlMap.down.up();
			})
			
			action.SC_moveLeft = keyPress(function () {
				director.directControlMap.left.down();
			}, function () {
				director.directControlMap.left.up();
			})
			
			action.SC_moveRight = keyPress(function () {
				director.directControlMap.right.down();
			}, function () {
				director.directControlMap.right.up();
			})
			var clickTitle = function (fn) {
				return function () {
					$('.video-bar-item').each(function () {
						var index = this.getAttribute('data-index');
						var $title = $(this).find('.video-bar-item-title');
						if ($.isFunction(fn)) {
							if (fn($title.html(), index)) {
								$title.click();
								return false;
							}
						} else if (fn == $title.html()) {
							$title.click();
							return false;
						}
					});
				}
			};
			action.SC_teaFollow = keyPress(clickTitle('教师跟踪'));
			action.SC_teaAll = keyPress(clickTitle('教师全景'));
			action.SC_stuFollow = keyPress(clickTitle('学生跟踪'));
			action.SC_stuAll = keyPress(clickTitle('学生全景'));
			
			action.SC_blackboard = keyPress(clickTitle('教师板书'));
			action.SC_vga = keyPress(clickTitle('VGA'));
			
			action.SC_room1 = keyPress(function () {
				$('.video-bar-item[data-receiver=1]:eq(0) .video-bar-item-title').click();
			});
			action.SC_room2 = keyPress(function () {
				$('.video-bar-item[data-receiver=1]:eq(1) .video-bar-item-title').click();
			});
			action.SC_room3 = keyPress(function () {
				$('.video-bar-item[data-receiver=1]:eq(2) .video-bar-item-title').click();
			});
			
			var clickYz = function (i) {
				return function () {
					$('.camera-preset-box .type1:eq(' + (i-1) + ')').click();
				}
			};
			for (var i = 1; i < 10; i++) {
				action['SC_videoYZ' + i] = keyPress(clickYz(i));
			}
		},
		init: function () {
			var self = this;
			$('.shortCut-btn').on('click', function () {
				shortCut.openConfigDlg();
			});
			
			var timeId = 0;
			$(document).on('click', '.small-video-cover', function (event) {
				var $elm = $(this);
				if (event.button == 0) {//左点击
					clearTimeout(timeId);
					timeId = setTimeout(function () {
						self.fire('click0', 'click', $elm, event);
					}, 200);
				} else {
					self.fire('click' + event.button, 'click', $elm, event);
				}
			}).on('dblclick', '.small-video-cover', function (event) {
				if (event.button == 0) {//左点击
					clearTimeout(timeId);
				}
				self.fire('dblclick' + event.button, 'click', $(this), event);
			}).on('contextmenu', '.small-video-cover', function (event) {
				self.fire('click2', 'click', $(this), event);
				return false;
			}).on('keypress', function (event) {
				console.log('keypress', String.fromCharCode(event.which), +new Date());
				event = event || window.event;
				var nodeName = event.target.nodeName.toLowerCase();
				if (nodeName == 'input' || nodeName == 'textarea') {
					return;
				}
				if ($('#masker').length > 0) return;
				if(0==event.which) {
					switch(event.keyCode) {
					case 37:
						self.fire('key<left>', 'keypress');
						break;
					case 38:
						self.fire('key<up>', 'keypress');
						break;
					case 39:
						self.fire('key<right>', 'keypress');
						break;
					case 40:
						self.fire('key<down>', 'keypress');
						break;
					}
				} else if (event.which == 32) {
					self.fire('key<space>', 'keypress');
				} else {
					self.fire('key' + String.fromCharCode(event.which).toLowerCase(), 'keypress');
				}
			});/*.on('keyup', function (event) {
				console.log('keyup', String.fromCharCode(event.which));
				var nodeName = event.target.nodeName.toLowerCase();
				if (nodeName == 'input' || nodeName == 'textarea') {
					return;
				}
				if ($('#masker').length > 0) return;
				
				if (event.which == 32) {
					self.fire('key<space>', 'keyup');
				} else {
					self.fire('key' + String.fromCharCode(event.which).toLowerCase(), 'keyup');
				}
			});*/
			addEvent($('.video-bar')[0], "mousewheel", function (event) {
				var $elm = $(event.target);
				if ($elm.hasClass('small-video-cover')) {
					var index = $elm.parents('.video-bar-item').attr('data-index');
					if (index) {
						if (event.delta  > 0) {
							self.fire('mousewheelup', 'wheel', $elm);
						} else if (event.delta  < 0) {
							self.fire('mousewheeldown', 'wheel', $elm);
						}
						event.preventDefault()
					}		
				}
				console.log(event, event.delta, event.target);
			})
			
			/*
			
			.on('mousewheel', '.small-video-cover', function (event) {
				
				return false;
			})*/
			this.setActions();
		},
		save: function () {
			this.setName();
			remote.call('configString', 'shortCut', JSON.stringify(SHORT_CONFIG));
		},
		initPage: function (json) {
			SHORT_CONFIG = json.shortCut || {};
			SHORT_CONFIG = $.extend(defaultConfig, SHORT_CONFIG)
			this.setName();
		}
	};
	shortCut.init();
	director.addModule('shortCut', shortCut);
})();
</script>
<script>
(function (undefine) {
	var getSelectHtml = util.getSelectHtml;
	var tmpl = util.template($('#picModeTmpl').html());
	var trTmpl = util.template($('#picModeTrTmpl').html());
	var recordModeTmpl = util.template($('#recordModeTmpl').html());
	
	var mainData;
	var picModeData =  {};
	var picModeDataTmp;
	
	var picMode = {
		extendDirector: function (director) {
			var self = this;
			director.getPicMode = function () {
				return picModeData.picModeUseIndex;
			}
			director.picModeChange = function (index) {
				console.log('director.picModeChange:'+index);
				picModeData.picModeSelectIndex = picModeData.picModeUseIndex = index;
				$('.picmode-bar .box:eq(' + picModeData.picModeUseIndex + ')').addClass('selected').siblings().removeClass('selected');
			}
		},
		init: function () {
			var self = this;
			var $dialog;
			$('.picmode-btn').on('click', function () {
				console.log(mainData.videoBarData);
				var barNum = director.getMaxIndex(mainData.videoBarData.map) -1;
				var winTab = [1,2,3,4,5,6,7,8,9];
				winTab.length = barNum;
				
				var dialog = Win.open({
					title: "画面显示",
					width: 850,
					mask: true,
					html: tmpl({data: picModeData, videoBarData: mainData.videoBarData, winTab: winTab, action: 'pip'})
				});
				$dialog = $(dialog.dom);
				$dialog.on('click', '.dialog-add-btn', function () {
					var action = $dialog.find('.pop-tab-nav a.selected').attr('data-action');					
					var num = picModeData[action + 'Num'];
					var map = {};
					$dialog.find('tr').each(function (index) {
						if (index > 0) {
							var winIndex = this.getAttribute('data-winIndex');
							var tab = map[winIndex] = [];
							$(this).find('.picmode-select').each(function () {
								tab.push(this.value);
							})
							map[winIndex] = tab;
						}	
					});
					picModeData[action + 'Map'] = map;
					var pos = picModeData[action + 'Pos'] = $dialog.find("input:checked").val();
					remote.call('updatePicMode', action, num, map, pos);
					dialog.close();
				}).on('click', '.pop-tab-nav a', function () {
					var $elm = $(this);
					var action = $elm.attr('data-action');
					if (!$elm.hasClass('selected')) {
						$elm.addClass('selected').siblings().removeClass('selected');
						$dialog.find('.dialog_Cont').html(tmpl({data: picModeData, videoBarData: mainData.videoBarData, winTab: winTab, action: action}));
					}
				});
				picModeDataTmp = $.extend(true, {}, picModeData);
			});
			
			$doc.on('change', '.picmode-select', function () {
				var action = $dialog.find('.pop-tab-nav a.selected').attr('data-action');
				var $tr = $(this).parents('tr');
				var winIndex = $tr.attr('data-winIndex');
				var tab = [];
				var _v = this.value;
				var elm = this;
				$tr.find('.picmode-select').each(function (index) {
					if (_v != '-1' && _v == this.value && elm != this) {
						tab.push(-1);
					} else {
						tab.push(this.value);
					}
				})
				picModeDataTmp[action + 'Map'][winIndex] = tab;
				$tr.html(trTmpl({
					action: action,
					winTab: [winIndex],
					data: picModeDataTmp, 
					videoBarData: mainData.videoBarData
				}));
			});
			
			$('.recordMode-btn').on('click', function () {
				var videoBarData = mainData.videoBarData;
				var barNum = director.getMaxIndex(videoBarData.map) -1;
				var winTab = [1,2,3,4,5,6,7,8,9];
				winTab.length = barNum;
				
				var isRecord = director.isRecord();
				var recordMode = director.getRecordMode();
				var dialog = Win.open({
					title : "录制设置",
					width: 700,
					mask: true,
					html : recordModeTmpl({
						data: picModeData, 
						videoBarData: videoBarData, 
						winTab: winTab,
						isRecord: isRecord,
						recordMode: recordMode
					})
				});
				var $dialog = $(dialog.dom).addClass('noMenu');
				
				$dialog.on('click', 'input', function () {
					console.log(this.checked, this.value);
					var $tr = $(this).parents('tr');
					var index = $tr.attr('data-winindex');
					if (this.name == "videoRecord") {
						if (index) {
							remote.call('videoRecord', index, this.checked);
							videoBarData.map[index].videoRecord = this.checked;
						}
					} else {
						videoBarData.map[index].videoBitrate = this.value;
						remote.call('videoBitrate', index, this.value);
					}
						
				});
				$dialog.on('click', function (event) {
					var group = $(event.target).attr('data-group');
					if (group == "videoRecord") {
						if (isRecord) {
							Win.alert({
								width: 260,
								html: '录制状态不能进行视频录制。'
							});
							return;
						}
						if (recordMode == 0) {
							Win.alert({
								width: 260,
								html: '电影模式不能录制。'
							});
							return;
						}
					}
					if (group == "videoBitrate") {
						if (isRecord) {
							Win.alert({
								width: 260,
								html: '录制状态不能进行视频设置。'
							});
							return;
						}
					}
				});
			});			
						
			$('.picmode-bar').on('click', '.box', function () {
				picModeData.picModeSelectIndex = picModeData.picModeUseIndex = this.getAttribute('data-modeIndex')*1;
				remote.call('videoStitchMode', picModeData.picModeSelectIndex, function(res) {
					var number = slotControl.getLight(6, picModeData.picModeSelectIndex, 22);
					slotControl.setDirectorMode(number);
				});
				$(this).addClass('selected').siblings('.box').removeClass('selected');
				director.setCameraControl();
			})
			
			director.addModule('picMode', this);
		},
		initPage: function (json) {
			if (json.picModeData === undefine) return;
			isInitPage = true;
			mainData = json;
			picModeData = json.picModeData;
			picModeData.picModeSelectIndex = picModeData.picModeUseIndex;//兼容select,没必要
			$('.picmode-bar .box:eq(' + picModeData.picModeUseIndex + ')').addClass('selected').siblings().removeClass('selected');
		}
	};
	picMode.init();
})();
</script>
<script>
(function (undefine) {
	var getSelectHtml = util.getSelectHtml;
	var tmpl = util.template($('#logoTmpl').html());
	var logoData =  {map:{}};
	var addCheck = function (map, title) {
		var i = 0;
		for (var key in map) {
			i++;
			if (map[key].title == title) {
				return 2;//标题已存在
			}
		}
		if (i >= 18) {
			return 1;//数量超过18
		}
		return 0;//成功
	};
	var logo = {
		init: function () {
			var self = this;
			$('.logo-btn').on('click', function () {
				var dialog = Win.open({
					title : "台标设置",
					width: 700,
					mask: true,
					html : tmpl({data: logoData, action: 'sel', pageNo: 1}),
					afterClose: function () {
						self.rushSelect();
					}
				});
				var $dialog = $(dialog.dom);
				$dialog.on('click', '.pop-tab-nav a', function () {
					var $elm = $(this);
					var action = $elm.attr('data-action');
					if (!$elm.hasClass('selected')) {
						$elm.addClass('selected').siblings().removeClass('selected');
						$dialog.find('.dialog_Cont').html(tmpl({data: logoData, action: action, pageNo: 1}));
						if (action == 'add') {
							var logoUpload = new UploadFile($('#logoDialogAddPathBtn .uploadCont')[0],false,"${PUBLIC_PATH}/public/upload/uploadFile.swf",{
									fileType : "*.png;*.jpg;*.bmp",
									typeDesc : "图片",
									debug : DEBUG,
									server: encodeURIComponent(WEN_UPLOAD_URL)
								});
								logoUpload.uploadEvent.add("noticeTypeError",function(){
									var elm = arguments[0].message[0],
							 			fileType = arguments[0].message[1],
							 			info = arguments[0].message[2];
										Win.alert("只支持以下图片类型：*.png;*.jpg;*.bmp");
								});
								logoUpload.uploadEvent.add("noticeSizeError",function(){
									var elm = arguments[0].message[0],
							 			limite = arguments[0].message[1],
							 			info =  arguments[0].message[2];
										Win.alert({
											html: "上传图片过大：限制大小：" + (limite/1024/1024) + "MB",
											width: 450
										});
								});
								logoUpload.uploadEvent.add("onComplete",function(){
									var elm = arguments[0].message[0],
							 			data = JSON.parse(arguments[0].message[1]);
									if (data.result) {
										$('#logoDialogAddPath').val(data.message.replace(/\//g, "\\\\"));
									} 
								});
							
						}
					}
				}).on('click', '.dialog-page button', function () {
					var $elm = $(this);
					if (!$elm.hasClass('selected')) {
						var action = $dialog.find('.pop-tab-nav a.selected').attr('data-action');
						$dialog.find('.dialog_Cont').html(tmpl({data: logoData, action: action, pageNo: $elm.html()*1}));
					}
				}).on('click', '.dialog-edit-btn', function () {
					var $elm = $(this);
					var key = $elm.parents('tr').attr('data-key');
					$dialog.find('.dialog_Cont').html(tmpl({data: logoData, action: 'edit', pageNo: $elm.html()*1, key: key}));
				}).on('click', '.dialog-show2-btn', function () {
					var $lem = $(this);
					var $box = $lem.parents('.pop-tab-box');
					var action = $dialog.find('.pop-tab-nav .selected').attr('data-action');
					var json = util.getFormData($box);
					if (!json.path && action == 'add') {
						Win.alert("请上传台标文件。");
						return false;
					}
					if (director.checkNumIpt($('#logoDialogPosX')[0]) === false) {
						return false;
					}
					if (director.checkNumIpt($('#logoDialogPosY')[0]) === false) {
						return false;
					}
					json.pos =  json.pos * 1;
					var logoPosX = json.x = json.x * 1;
					var logoPosY = json.y = json.y * 1;
					if (json.pos == -1) {
						if (  logoPosX < 0 || logoPosX > 1920) {
							Win.alert({
								html: "台标横向位置范围是0—1920之间的整数，请重新输入。",
								width: 450
							});
							return false;								
						}
						if (logoPosY < 0 || logoPosY > 1080) {
							Win.alert({
								html: "台标纵向位置范围是0—1080之间的整数，请重新输入。",
								width: 450
							});
							return false;								
						}
					}
					self.preview(json);
				}).on('click', '.dialog-show-btn', function () {
					var $elm = $(this);
					var key = $elm.parents('tr').attr('data-key');
					var data = logoData.map[key];
					self.preview(data);
				}).on('click', '.dialog-del-btn', function () {
					var $elm = $(this);
					var $tr = $elm.parents('tr');
					
					var key = $tr.attr('data-key');
					if ($tr.find('.selected').length > 0) {
						Win.alert({
							title: "提示",
							html: "启用中的台标不能删除。",
							width: 300,
							mask: true
						});
					} else {
						Win.confirm({
							title: "提示",
							html: "确定要删除选中的台标吗？",
							width: 300,
							mask: true
						}, function () {
							//验证数据
							self.delLogo(key);
							dialog.close();
						}, true);
					}
				//}).on('click', '.dialog-turnOn-btn', function () {
				}).on('click', '.dialog-add-btn', function () {
					var $lem = $(this);
					var $box = $lem.parents('.pop-tab-box');
					var action = $dialog.find('.pop-tab-nav .selected').attr('data-action');
					var json = util.getFormData($box);
					if (!json.title) {
						Win.alert("请输入台标名称。");
						return false;
					}
					if (!json.path && action == 'add') {
						Win.alert("请上传台标文件。");
						return false;
					}
					if (director.checkNumIpt($('#logoDialogPosX')[0]) === false) {
						return false;
					}
					if (director.checkNumIpt($('#logoDialogPosY')[0]) === false) {
						return false;
					}
					json.pos =  json.pos * 1;
					var logoPosX = json.x = json.x * 1;
					var logoPosY = json.y = json.y * 1;
					if (json.pos == -1) {
						if (  logoPosX < 0 || logoPosX > 1920) {
							Win.alert({
								html: "台标横向位置范围是0—1920之间的整数，请重新输入。",
								width: 450
							});
							return false;								
						}
						if (logoPosY < 0 || logoPosY > 1080) {
							Win.alert({
								html: "台标纵向位置范围是0—1080之间的整数，请重新输入。",
								width: 450
							});
							return false;								
						}
					}
					if (action == 'add') {
						var res = addCheck(logoData.map, json.title);
						if (res != 0) {
							var html = "";
							if (res == 1) 
								html = '最多添加18个台标。';
							if (res == 2) 
								html = '台标名称已存在，请重新输入。';
							Win.alert({
								html: html,
								width: 280
							});		
							return false;
						}
					}
					if (action == 'edit') {
						self.editlLogo($box.attr('data-key'), json);
					} else {
						self.addlLogo(json);
					}
					dialog.close();
				});
				
			});	
			$doc.on('change', "#logoDialogPos", function () {
				if (this.value == -1) {
					$('#logoDialogPosX,#logoDialogPosY').attr('disabled', null);
				} else {
					$('#logoDialogPosX,#logoDialogPosY').attr('disabled', "disabled");
					if ($.trim($('#logoDialogPosX').val()) == "" ) {
						$('#logoDialogPosX').val(logoData.logoPosX);
					}
					if ($.trim($('#logoDialogPosY').val()) == "" ) {
						$('#logoDialogPosY').val(logoData.logoPosY);
					}
				}
			});
			director.addModule('logo', this);
		},
		preview: function (data) {
			var pos = data.pos;
			var path = WEN_UPLOAD_HOST + '/Preview?file=' + encodeURIComponent(util.Base64.encode(data.path));
			var html = "";
			if (pos == 0) {
				html = "left: 0;top: 0;";
			} else if (pos == 1) {
				html = "right: 0;top: 0;";
			} else if (pos == 2) {
				html = "left: 0;bottom: 0;";
			} else if (pos == 3) {
				html = "right: 0;bottom: 0;";
			} else if (pos == -1) {
				html = "left: " + data.x/2 + "px;top: " + data.y/2 + "px;";
			}
			var image = new Image();
			image.onload = function () {
				html += "width:"+ image.width/2 + "px;height:"+ image.height/2 + "px;"
				Win.open({
					title : "台标预览" + (data.title? ' : ' + data.title : ''),
					mask: true,
					width: 1000,
					html : '<div class="logo-show"><img style="' + html + '" src="' + path + '" /></div>'
				})
			};
			image.src = path;
		},
		rushSelect: function () {
			var map = logoData.map;
			var tab = [{text: '请选择', value: -2}];
			for (var key in map) {
				tab.push({text: map[key].title, value: key})
			}
			$('#logoSelect').jsSelect('extendOpt', {
				data: tab
			}).jsSelect('val', logoData.logoSelectIndex);
			if (logoData.logoUseIndex != -1 && logoData.logoUseIndex == logoData.logoSelectIndex) {
				$('.turnOn-btn[data-remote=logo]').addClass('selected');
				$('#logoSelect').addClass('disable2');
			}
		},
		initPage: function (json) {
			if (json.logoData === undefine) return;
			logoData = json.logoData;
			logoData.logoSelectIndex = logoData.logoUseIndex;
			if (logoData.logoUseIndex >= 0 ) {
				$('.logo-box .turnOn-btn').addClass('selected');
				$('#logoSelect').jsSelect('disable2');
			}
			this.rushSelect();
		},
		updateLogo: function (json) {
			remote.call('logoPostion', {pos: logoData.logoPos, x: logoData.logoPosX, y: logoData.logoPosY});
		},
		delLogo: function (indexs) {
			if (indexs == "") return;
			var map = logoData.map;
			$.each(indexs.split(','), function () {
				if (logoData.logoSelectIndex == this) {
					logoData.logoSelectIndex = -2;
				}
				map[this] = null;
				delete map[this];
			})
			remote.call('delLogo', indexs);
			return;
			
			if (indexs == "") return;
			var map = logoData.map;
			$.each(indexs.split(','), function () {
				if (logoData.logoSelectIndex == this) {
					logoData.logoSelectIndex = -2;
				}
			})
			var changeUseIndex = -1;
			var delInfo = director.getTabDelInfo(map, indexs);
			director.delMap(delInfo, function (nIndex, oIndex) {
				map[oIndex] = map[nIndex];
				if (logoData.logoSelectIndex == nIndex) {
					logoData.logoSelectIndex = oIndex;
				}
				if (logoData.logoUseIndex == nIndex) {
					logoData.logoUseIndex = oIndex;
					changeUseIndex = logoData.logoUseIndex;
				}
			}, function (index) {
				map[index] = null;
				delete map[index];
			});
			remote.call('delLogo2', delInfo, changeUseIndex);
		},
		addlLogo: function (json) {
			var max = director.getMaxIndex(logoData.map);
			logoData.map[max] = deepCopy(json);
			json.path = encodeURIComponent(json.path);
			remote.call('logoInfo', max, json);
		},
		editlLogo: function (index, json) {
			var obj = logoData.map[index];
			$.extend(obj, json);
			var sendJson = deepCopy(obj);
			sendJson.path = encodeURIComponent(sendJson.path);
			remote.call('logoInfo', index, sendJson);
		}
	};
	logo.init();
})();
</script>
<script>
(function (undefine) {
	//1.点击确定关闭窗口，2.切换tab重绘html,3.自动维护。。
	//**增删
	var tmpl = util.template($('#headendTmpl').html());
	var getSelectHtml = util.getSelectHtml;
	var headData =  {map: {}};
	var endData = {map: {}};
	var addCheck = function (map, title) {
		var i = 0;
		for (var key in map) {
			i++;
			if (map[key].title == title) {
				return 2;//标题已存在
			}
		}
		if (i >= 16) {
			return 1;//数量超过16
		}
		return 0;//成功
	};
	var headend = {
		init: function () {
			var self = this;
			$('.headend-btn').on('click', function () {
				var isRecord = director.isRecord();
				if(isRecord){
					Win.alert("录制状态不能设置片头片尾！");
					return;
				}
				var dialog = Win.open({
					title: "片头/片尾设置",
					width: 700,
					mask: true,
					html: tmpl({headData: headData, endData: endData, action: 'selHead', pageNo: 1, dataFilter: -2}),
					afterClose: function () {
						self.rushSelect();
					}
				});
				var $dialog = $(dialog.dom);
				$dialog.on('click', '.pop-tab-nav a', function () {
					var $elm = $(this);
					var action = $elm.attr('data-action');
					if (!$elm.hasClass('selected')) {
						$elm.addClass('selected').siblings().removeClass('selected');
						$dialog.find('.dialog_Cont').html(tmpl({headData: headData, endData: endData, action: action, pageNo: 1, dataFilter: -2}));
						if (action == 'add') {
							$.each(['head', 'end'], function () {
								var type = this;
								var headEndUpload = new UploadFile($('#' + type + 'DialogAddPathBtn .uploadCont')[0],false,"${PUBLIC_PATH}/public/upload/uploadFile.swf",{
										fileType : "*.png;*.jpg;*.bmp;*.flv;*.mp4;*.avi;*.mov;*.wmv",
										typeDesc : "图片,视频",
										debug : DEBUG,
										server: encodeURIComponent(WEN_UPLOAD_URL)
									});
									headEndUpload.uploadEvent.add("noticeSizeError",function(){
										var elm = arguments[0].message[0],
								 			limite = arguments[0].message[1],
								 			info =  arguments[0].message[2];
											Win.alert({
												html: "上传图片过大：限制大小：" + (limite/1024/1024) + "MB",
												width: 450
											});
									});
									headEndUpload.uploadEvent.add("onComplete",function(){
										var elm = arguments[0].message[0],
											data = JSON.parse(arguments[0].message[1]);
										if (data.result) {
											$('#' + type + 'DialogAddPath').val(data.message.replace(/\//g, "\\\\"));
										} 
									});
							})
						}
					}
				}).on('click', '.dialog-page button', function () {
					var $elm = $(this);
					if (!$elm.hasClass('selected')) {
						var action = $dialog.find('.pop-tab-nav a.selected').attr('data-action');
						$dialog.find('.dialog_Cont').html(tmpl({headData: headData, endData: endData, action: action, pageNo: $elm.html()*1, dataFilter: $('#headendFilter').val()}));
					}
				}).on('click', '.dialog-show-btn', function () {
					var $elm = $(this);
					var $tr = $elm.parents('tr');
					var key = $tr.attr('data-key');
					var action = $dialog.find('.pop-tab-nav .selected').attr('data-action');
					var data = headData.map[key];
					if (action == 'selEnd') {
						data = endData.map[key];
					}
					self.preview(data);
				}).on('click', '.dialog-add-btn', function () {
					var $lem = $(this);
					var $box = $lem.parents('.pop-tab-box');
					var action = $dialog.find('.pop-tab-nav .selected').attr('data-action');
					var json = util.getFormData($box);
					if(MOVIE_HEAD_UP || MOVIE_FOOT_UP) {
						Win.alert("您的操作太频繁了，有片头或片尾正在生成，请稍等！");
						return false;
					}
					if (!json.headData.title && json.headData.path) {
						Win.alert('请上传片头名称。');
						return false;
					}
					if (json.headData.title && !json.headData.path) {
						Win.alert('请输入片头文件。');
						return false;
					}
					if (director.checkNumIpt($('#headDialogAddTime')[0]) === false) {
						return false;
					}
					if (json.headData.title && json.headData.path && json.headData.type == 0) {
						if (json.headData.seconds == 0) {
							Win.alert('请输入片头显示时间。');
							return false;
						}
						if (json.headData.seconds > 20) {
							Win.alert('片头显示时间最多20秒。');
							return false;
						}							
					}
					var headFilePath = json.headData.path;
					if(headFilePath.replace(/(^\s*)|(\s*$)/g, "").length>0) {
						var headFilePathArr = headFilePath.split(/\./);
						var headPattern = headFilePathArr.pop();
						if(json.headData.type == 0) {
							if(-1==IMG_PATTERN.indexOf(headPattern)) {
								Win.alert("片头文件格式有误，不是图片。");
								return ;
							}
						} else {
							if(-1==MOVIE_PATTERN.indexOf(headPattern)) {
								Win.alert("片头文件格式有误，不是视频。");
								return ;
							}
						}
					}
					var footFilePath = json.endData.path;
					if(footFilePath.replace(/(^\s*)|(\s*$)/g, "").length>0) {
						var footFilePathArr = footFilePath.split(/\./);
						var footPathern = footFilePathArr.pop();
						if(json.endData.type == 0) {
							if(-1==IMG_PATTERN.indexOf(footPathern)) {
								Win.alert("片尾文件格式有误，不是图片。");
								return ;
							}
						} else {
							if(-1==MOVIE_PATTERN.indexOf(footPathern)) {
								Win.alert("片尾文件格式有误，不是视频。");
								return ;
							}
						}
					}
					if (!json.endData.title && json.endData.path) {
						Win.alert('请上传片尾名称。');
						return false;
					}
					if (json.endData.title && !json.endData.path) {
						Win.alert('请输入片尾文件。');
						return false;
					}
					if (director.checkNumIpt($('#endDialogAddTime')[0]) === false) {
						return false;
					}
					if (json.endData.title && json.endData.path && json.endData.type == 0) {
						if (json.endData.seconds == 0) {
							Win.alert('请输入片尾显示时间。');
							return false;
						}
						if (json.endData.seconds > 20) {
							Win.alert('片尾显示时间最多20秒。');
							return false;
						}
					}												
					if (!json.endData.title || !json.endData.path) {
						delete json.endData;
					}
					if (!json.headData.title || !json.headData.path) {
						delete json.headData;
					}
					if (json.headData) {
						var res = addCheck(headData.map, json.headData.title);
						if (res != 0) {
							var html = "";
							if (res == 1) 
								html = '最多添加16个片头。';
							if (res == 2) 
								html = '片头名称已存在，请重新输入。';
							Win.alert({
								html: html,
								width: 280
							});
							return false;
						}
					}
					if (json.endData) {
						var res = addCheck(endData.map, json.endData.title);
						if (res != 0) {
							var html = "";
							if (res == 1) 
								html = '最多添加16个片尾。';
							if (res == 2) 
								html = '片尾名称已存在，请重新输入。';
							Win.alert({
								html: html,
								width: 280
							});
							return false;
						}
					}
					if (json.headData && json.headData.path) {
						json.headData.path = util.Base64.encode(json.headData.path);
						MOVIE_HEAD_UP = true;
					}
					if (json.endData && json.endData.path) {
						json.endData.path = util.Base64.encode(json.endData.path);
						MOVIE_FOOT_UP = true;
					}
					//验证数据
					self.addHeadEnd(json);
					dialog.close();
				}).on('click', '.dialog-del-btn', function () {
					var $elm = $(this);
					var $tr = $elm.parents('tr');
					var key = $tr.attr('data-key');
					var action = $dialog.find('.pop-tab-nav .selected').attr('data-action');
					if ($tr.find('.selected').length > 0) {
						var html = "启用中的片头不能删除。"
						if (action == 'selEnd') {
							html = "启用中的片尾不能删除。"
						}
						Win.alert({
							title: "提示",
							html: html,
							width: 300,
							mask: true
						});
					} else {
						var html = "确定要删除选中的片头吗？"
						if (action == 'selEnd') {
							html = "确定要删除选中的片尾吗？"
						}
						Win.confirm({
							title: "提示",
							html: html,
							width: 300,
							mask: true
						}, function () {
							//验证数据
							if (action == 'selHead') {
								self.delHeadEnd(key, '');
							} else {
								self.delHeadEnd('', key);
							}
							dialog.close();
						}, true);
					}
				}).on('change', "#headendFilter", function () {
					var $elm = $(this);
					var action = $dialog.find('.pop-tab-nav a.selected').attr('data-action');
					$dialog.find('.dialog_Cont').html(tmpl({headData: headData, endData: endData, action: action, pageNo: 1, dataFilter: this.value}));
				});
			});
			$doc.on('change', "#headDialogAddType,#endDialogAddType", function () {
				var key = this.id.replace("DialogAddType", "");
				if (this.value == 0) {
					$('#' + key + 'DialogAddTime').attr('disabled', null);
				} else {
					$('#' + key + 'DialogAddTime').attr('disabled', "disabled");
				}
			});
			$doc.on('change', "#headDialogSelectList,#endDialogSelectList", function () {
				var index = this.value;
				if (index == -2) return;
				
				var mode = this.id.replace('DialogSelectList', '');
				var map = headData.map;
				if (mode == 'end') {
					map = endData.map;
				}
				var obj = map[index];
				if (obj && obj.state == 0) {
					if (mode == 'head') {
						Win.alert(util.html2Escape(obj.title) + '片头还在生成中');
					} else {
						Win.alert(util.html2Escape(obj.title) + '片尾还在生成中');
					}
					this.selectedIndex = 0;
				}
			})
			director.addModule('headend', this);
		},
		preview: function (data) {
			console.log(data);
			if (data && data.state == 0) {
				if (mode == 'head') {
					Win.alert(util.html2Escape(obj.title) + '片头还在生成中');
					return;
				} else {
					Win.alert(util.html2Escape(obj.title) + '片尾还在生成中');
					return;
				}
			}
			var html = '<embed width="700" height="430" wmode="direct" flashvars="url=' + WEN_UPLOAD_HOST + '/Player/'+ encodeURIComponent(util.Base64.encode(data.outputPath)) + '&skin=${PUBLIC_PATH}/public/player/MinimaFlatCustomColorAll.swf&autoplay=1" allowscriptaccess="always" allowfullscreeninteractive="true" allowfullscreen="true" allownetworking="all" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/shockwave/download/index.cgi?P1_Prod_Version=ShockwaveFlash" src="${PUBLIC_PATH}/public/player/videoPlayer.swf">';
        	parent.Win.open({
        		title : data.title,
        		mask : true,
        		html : html,
        		width: 740,
        		height: 510
        	});
		},
		rushSelect: function (type) {
			if (!type || type == 'head') {
				var map = headData.map;
				var tab = [{text: '请选择', value: -2}];
				for (var key in map) {
					tab.push({text: map[key].title, value: key})
				}
				$('#headSelect').jsSelect('extendOpt', {
					data: tab
				}).jsSelect('val', headData.headSelectIndex);
				if (headData.headUseIndex != -1 && headData.headUseIndex == headData.headSelectIndex) {
					$('.turnOn-btn[data-remote=movieHead]').addClass('selected');
					$('#headSelect').addClass('disable2');
				}
			}
			if (!type || type == 'end') {
				var map = endData.map;
				var tab = [{text: '请选择', value: -2}];
				for (var key in map) {
					tab.push({text: map[key].title, value: key})
				}
				$('#endSelect').jsSelect('extendOpt', {
					data: tab
				}).jsSelect('val', endData.endSelectIndex);
				if (endData.endUseIndex != -1 && endData.endUseIndex == endData.endSelectIndex) {
					$('.turnOn-btn[data-remote=movieEnd]').addClass('selected');
					$('#endSelect').addClass('disable2');
				}
			}
		},
		initPage: function (json) {
			if (json.headData) {
				headData = json.headData;
				headData.headSelectIndex = headData.headUseIndex;
				this.rushSelect('head');
			} 
			if (json.endData) {
				endData = json.endData;
				endData.endSelectIndex = endData.endUseIndex;
				this.rushSelect('end');
			}
		},
		extendDirector: function (director) {
			director.MovieEncodeOver = function (type, index, data) {
				var obj = headData.map[index];
				var mode = 'head';
				if (type == 1) {
					obj = endData.map[index];
					mode = 'end';
				}
				if (obj) {
					$.extend(obj, data);
					obj.state = 1;
					if (mode == 'head') {
						MOVIE_HEAD_UP = false;
						Win.alert(util.html2Escape(obj.title) + '片头生成完成');
					} else {
						MOVIE_FOOT_UP = false;
						Win.alert(util.html2Escape(obj.title) + '片尾生成完成');
					}
				}
			};
		},
		addHeadEnd: function (json) {
			var flag = false;
			if (json.headData) {
				var maxHead = director.getMaxIndex(headData.map);
				headData.map[maxHead] = json.headData;
				json.headData.state = 0;
				flag = true;
			}
			if (json.endData) {
				var maxEnd = director.getMaxIndex(endData.map);
				endData.map[maxEnd] = json.endData;
				json.endData.state = 0;
				flag = true;
			}
			if (flag) {
				remote.call('addHeadEnd', maxHead, json.headData, maxEnd, json.endData);
			}
		},
		delHeadEnd: function (headIndexs, endIndexs) {
			var map = headData.map;
			$.each(headIndexs.split(','), function () {
				if (headData.headSelectIndex == this) {
					headData.headSelectIndex = -2;
				}
				map[this] = null;
				delete map[this];
			})
			var map = endData.map;
			$.each(endIndexs.split(','), function () {
				if (endData.endSelectIndex == this) {
					endData.endSelectIndex = -2;
				}
				map[this] = null;
				delete map[this];
			})
			if (headIndexs != "" || endIndexs != "")
				remote.call('delHeadEnd', headIndexs, endIndexs);
			return;	
			var headDelInfo = "";
			$.each(headIndexs.split(','), function () {
				if (headData.headSelectIndex == this) {
					headData.headSelectIndex = -2;
				}
			})
			if (headIndexs != "") {
				var headDataMap = headData.map;
				var changeHeadUseIndex = -1;
				headDelInfo = director.getTabDelInfo(headDataMap, headIndexs)
				director.delMap(headDelInfo, function (nIndex, oIndex) {
					headDataMap[oIndex] = headDataMap[nIndex];
					if (headData.headSelectIndex == nIndex) {
						headData.headSelectIndex = oIndex;
					}
					if (headData.headUseIndex == nIndex) {
						headData.headUseIndex = oIndex;
						changeHeadUseIndex = headData.headUseIndex;
					}
				}, function (index) {
					headDataMap[index] = null;
					delete headDataMap[index];
				});
			}
			
			var endDelInfo = "";
			$.each(endIndexs.split(','), function () {
				if (endData.endSelectIndex == this) {
					endData.endSelectIndex = -2;
				}
			})
			if (endIndexs != "") {
				var endDataMap = endData.map;
				var changeEndUseIndex = -1;
				endDelInfo = director.getTabDelInfo(endDataMap, endIndexs);
				director.delMap(endDelInfo, function (nIndex, oIndex) {
					endDataMap[oIndex] = endDataMap[nIndex];
					if (endData.endSelectIndex == nIndex) {
						endData.endSelectIndex = oIndex;
					}
					if (endData.endUseIndex == nIndex) {
						endData.endUseIndex = oIndex;
						changeEndUseIndex = endData.endUseIndex;
					}
				}, function (index) {
					endDataMap[index] = null;
					delete endDataMap[index];
				});
			}
			
			if (headDelInfo != "" || endDelInfo != "")
				remote.call('delHeadEnd2', headDelInfo, changeHeadUseIndex, headIndexs, endDelInfo, changeEndUseIndex, endIndexs);
		}
	};
	headend.init();
})();
</script>
<script>
	(function (undefine) {
		var getSelectHtml = util.getSelectHtml;
		var subtitleData = { map: {}};
		var fontFamilyTab = ['宋体', '楷体','仿宋体','幼圆','华文细黑','华文新魏','华文彩云'];
		var fontSizeTab = ['8', '9', '10', '11', '12', '14', '16', '18', '20', '24', '36', '72'];
		var fontStyleTab = ['正常', '斜体','下划线','斜体+下划线'];
		
		var colorMap = {
			"#ff0000": "红色",
			"#ffff00": "黄色",
			"#00ff00": "绿色",
			"#0000ff": "蓝色"
		};
		var colorData1 = [
			{text: '红色', value: "#ff0000"},
			{text: '黄色', value: "#ffff00"},
			{text: '绿色', value: "#00ff00"},
			{text: '蓝色', value: "#0000ff"}
		];
		var colorData2 = [
			{text: '透明', value: -1},
			{text: '红色', value: "#ff0000"},
			{text: '黄色', value: "#ffff00"},
			{text: '绿色', value: "#00ff00"},
			{text: '蓝色', value: "#0000ff"}
		];
		var addCheck = function (map, title) {
			var i = 0;
			for (var key in map) {
				i++;
				if (map[key].title == title) {
					return 2;//标题已存在
				}
			}
			if (i >= 18) {
				return 1;//数量超过18
			}
			return 0;//成功
		};
		var tmpl = util.template($('#subtitleTmpl').html());
		var subtitle = {
			init: function () {
				var self = this;	
				$('.subtitle-btn').on('click', function () {
					var extraTmpObj = {colorMap: colorMap,fontFamilyTab: fontFamilyTab,fontSizeTab: fontSizeTab,fontStyleTab: fontStyleTab};
					var dialog = Win.open({
						title : "字幕设置",
						width: 700,
						mask: true,
						html : tmpl($.extend({data: subtitleData, action: 'sel', pageNo: 1}, extraTmpObj)),
						afterClose: function () {
							self.rushSelect();
						}
					});
					var $dialog = $(dialog.dom);
					$dialog.on('click', '.pop-tab-nav a', function () {
						var $elm = $(this);
						var action = $elm.attr('data-action');
						if (!$elm.hasClass('selected')) {
							$elm.addClass('selected').siblings().removeClass('selected');
							$dialog.find('.dialog_Cont').html(tmpl($.extend({data: subtitleData, action: action, pageNo: 1}, extraTmpObj)));
						}
					}).on('click', '.dialog-page button', function () {
						var $elm = $(this);
						if (!$elm.hasClass('selected')) {
							var action = $dialog.find('.pop-tab-nav a.selected').attr('data-action');
							$dialog.find('.dialog_Cont').html(tmpl($.extend({data: subtitleData, action: action, pageNo: $elm.html()*1}, extraTmpObj)));
						}
					}).on('click', '.dialog-edit-btn', function () {
						var $elm = $(this);
						var $tr = $elm.parents('tr');
						if($tr.find('.selected').length > 0) {
							Win.alert({
								title: "提示",
								html: "启用中的字幕不能编辑。",
								width: 300,
								mask: true
							});
						} else {
							var key = $tr.attr('data-key');
							$dialog.find('.dialog_Cont').html(tmpl($.extend({data: subtitleData, action: 'edit', pageNo: $elm.html()*1, key: key}, extraTmpObj)));
						}
					}).on('click', '.dialog-del-btn', function () {
						var $elm = $(this);
						var $tr = $elm.parents('tr');
						
						var key = $tr.attr('data-key');
						if ($tr.find('.selected').length > 0) {
							Win.alert({
								title: "提示",
								html: "启用中的字幕不能删除。",
								width: 300,
								mask: true
							});
						} else {
							Win.confirm({
								title: "提示",
								html: "确定要删除选中的字幕吗？",
								width: 300,
								mask: true
							}, function () {
								//验证数据
								self.delSubtitle(key);
								dialog.close();
							}, true);
						}
					//}).on('click', '.dialog-turnOn-btn', function () {
					}).on('click', '.dialog-add-btn', function () {
						var $lem = $(this);
						var $box = $lem.parents('.pop-tab-box');
						var action = $dialog.find('.pop-tab-nav .selected').attr('data-action');
						var json = util.getFormData($box);
						json.desc = json.desc.replace(/\n/g,'');
						//验证数据
						if (!json.title ) {
							Win.alert({
								html: '请填写字幕名称。',
								width: 300
							});
							return false;
						}
						if (!json.desc) {
							Win.alert({
								html: '请填写字幕内容。',
								width: 300
							});
							return false;
						}
						if (action == 'add') {
							var res = addCheck(subtitleData.map, json.title);
							if (res != 0) {
								var html = "";
								if (res == 1) 
									html = '最多添加18条字幕。';
								if (res == 2) 
									html = '字幕名称已存在，请重新输入。';
								Win.alert({
									html: html,
									width: 280
								});		
								return false;
							}
						}
						//验证数据						
						if (director.checkNumIpt($('#subtitleDialogScrollTimes')[0]) === false) {
							return false;
						}
						if (director.checkNumIpt($('#subtitleDialogPosX')[0]) === false) {
							return false;
						}
						if (director.checkNumIpt($('#subtitleDialogPosY')[0]) === false) {
							return false;
						}	
						json.x = json.x * 1;
						json.y = json.y * 1;
						var subtitlePosX = json.x;
						var subtitlePosY = json.y;
						if (json.pos == -1) {								
							if (subtitlePosX < 0 || subtitlePosX > 1920) {
								Win.alert({
									html: "字幕横向位置范围是0—1920之间的整数，请重新输入。",
									width: 450
								});
								return false;
							}				
							if (subtitlePosY < 0 || subtitlePosY > 1080) {
								Win.alert({
									html: "字幕纵向位置范围是0—1080之间的整数，请重新输入。",
									width: 450
								});
								return false;								
							}
						}					
						if (action == 'edit') {
							self.editSubtitle($box.attr('data-key'), json);
						} else {
							self.addSubtitle(json);
						}
						dialog.close();
					});
					
				});
				$doc.on('change', '#subtitleDialogScrollMode', function () {
					if (this.value == 0) {
						$('#subtitleDialogScrollTimes').attr('disabled', true);
						if ($.trim($('#subtitleDialogScrollTimes').val()) == "" ) {
							$('#subtitleDialogScrollTimes').val(subtitleData.subtitleScrollTimes);
						}
					} else {
						$('#subtitleDialogScrollTimes').attr('disabled', false);
					}
				}).on('change', '#subtitleDialogScrollDir', function () {
					var v = this.value;
					if (v == 0) {
						$('#subtitleDialogScrollMode').html(util.getSelectHtml(['不滚动','向右滚动','向左滚动']));
						$('#subtitleDialogPos').html(getSelectHtml([{v:"0", t:'上方'},{v:"1", t:'下方'},{v:"-1", t:'自定义'}], {key:0 , text: 't', value:'v'}));
					} else {
						$('#subtitleDialogScrollMode').html(util.getSelectHtml(['不滚动','向上滚动','向下滚动']));
						$('#subtitleDialogPos').html(getSelectHtml([{v:"2", t:'左方'},{v:"3", t:'右方'},{v:"-1", t:'自定义'}], {key:2 , text: 't', value:'v'}));
					}
					$('#subtitleDialogScrollTimes').attr('disabled', true);
				}).on('change', '#subtitleDialogPos', function () {
					if (this.value != -1) {
						$('#subtitleDialogPosX,#subtitleDialogPosY').attr('disabled', true);
						if ($.trim($('#subtitleDialogPosX').val()) == "" ) {
							$('#subtitleDialogPosX').val(subtitleData.subtitlePosX);
						}
						if ($.trim($('#subtitleDialogPosY').val()) == "" ) {
							$('#subtitleDialogPosY').val(subtitleData.subtitlePosY);
						}
					} else {
						$('#subtitleDialogPosX,#subtitleDialogPosY').attr('disabled', false);	
					}
				})
				director.addModule('subtitle', this);
			},
			initPage: function (json) {
				if (json.subtitleData === undefine) return;
				subtitleData = json.subtitleData;
				subtitleData.subtitleSelectIndex = subtitleData.subtitleUseIndex;
				if (subtitleData.subtitleUseIndex >= 0 ) {
					$('.subtitle-box .turnOn-btn').addClass('selected');
					$('#subtitleSelect').jsSelect('disable2');
				}
				this.rushSelect();
			},
			updateSubtitle: function (isUpdatePos) {
				isUpdatePos = true;
				if (isUpdatePos) {
					remote.call('updateSubtitle', util.getKeyData(subtitleData, 'subtitleUseIndex,subtitleScrollMode,subtitleScrollTimes,subtitleFontColor,subtitleBackgroundColor,subtitlePos,subtitlePosX,subtitlePosY,subtitleFontFamily,subtitleFontSize,subtitleFontStyle'));
				} else {
					remote.call('updateSubtitle', util.getKeyData(subtitleData, 'subtitleUseIndex,subtitleScrollMode,subtitleScrollTimes,subtitleFontColor,subtitleBackgroundColor,subtitleFontFamily,subtitleFontSize,subtitleFontStyle'));
				}
			},
			delSubtitle: function (indexs) {
				if (indexs == "") return;
				var map = subtitleData.map;
				$.each(indexs.split(','), function () {
					if (subtitleData.subtitleSelectIndex == this) {
						subtitleData.subtitleSelectIndex = -2;
					}
					map[this] = null;
					delete map[this];
				})
				remote.call('delSubtitle', indexs);
				return;
				var map = subtitleData.map;
				$.each(indexs.split(','), function () {
					if (subtitleData.subtitleSelectIndex == this) {
						subtitleData.subtitleSelectIndex = -2;
					}
				})
				var changeUseIndex = -1;
				var delInfo = director.getTabDelInfo(map, indexs)
				director.delMap(delInfo, function (nIndex, oIndex) {
					map[oIndex] = map[nIndex];
					if (subtitleData.subtitleSelectIndex == nIndex) {
						subtitleData.subtitleSelectIndex = oIndex;
					}
					if (subtitleData.subtitleUseIndex == nIndex) {
						subtitleData.subtitleUseIndex = oIndex;
						changeUseIndex = oIndex;
					}
				}, function (index) {
					map[index] = null;
					delete map[index];
				});
				remote.call('delSubtitle2', delInfo, changeUseIndex);
			},
			addSubtitle: function (json) {
				var max = director.getMaxIndex(subtitleData.map);
				subtitleData.map[max] = json;
				remote.call('subtitleInfo', max, json);
				//this.updateSubtitle();//修复插件设计问题，新增需要设置相关属性
			},
			editSubtitle: function (index, json) {
				var obj = subtitleData.map[index];
				$.extend(obj, json);
				remote.call('subtitleInfo', index, obj);
			},
			rushSelect: function () {
				var map = subtitleData.map;
				var tab = [{text: '请选择', value: -2}];
				for (var key in map) {
					tab.push({text: map[key].title, value: key})
				}
				$('#subtitleSelect').jsSelect('extendOpt', {
					data: tab
				}).jsSelect('val', subtitleData.subtitleSelectIndex);
				if (subtitleData.subtitleUseIndex != -1 && subtitleData.subtitleUseIndex == subtitleData.subtitleSelectIndex) {
					$('.turnOn-btn[data-remote=subtitle]').addClass('selected');
					$('#subtitleSelect').addClass('disable2');
				}	
			}
		};
		subtitle.init();
	})();
</script>
<script>
    var remote = (function (undefined) {
        var callBackMap = {};
        var uuid = 1;
        var slice = Array.prototype.slice;
        return {
            call: function (fnName, p) {
            	console.log('remote call', fnName, p);
				//console.timeStamp();
                var args = slice.call(arguments, 0);
                var uid = uuid++;
                var needCallback = 0;
                if (args.length > 0 && $.isFunction(args[args.length-1])) {
                    needCallback = 1;
                    callBackMap[uid] = args.pop();
                }
                this.send('S', uid, needCallback, args);
            },
            send: function (opt, uid, needCallback, data) {
				//console.log('remote callOne');
				//console.timeStamp();
				/*COCO.send({
					to: MAIN_SPEAK, 
					api:"remoteGet", 
					type:'text', 
					opt: opt, 
					uid: uid, 
					needCallback: needCallback, 
					data: JSON.stringify(data).replace(/([\u4E00-\uFA29]|[\uE7C7-\uE7F3])+/g, function (str) {
						return encodeURIComponent(str)
					})
				});*/
                COCO.callOne(MAIN_SPEAK, "remoteMain.get", opt, uid, needCallback, data);
            },
            get: function (opt, uid, needCallback, data) {
                if (opt == 'S') {
                    var fnName = data.shift();
                    var res = director[fnName].apply(director, data);
                    if (needCallback == 1) {
                        remote.send('B', uid, needCallback, res)
                    }
                } else if (opt == "B") {
                    callBackMap[uid].call(null, data);
                    callBackMap[uid] = null;
                }
            }
        }
    })();
	
	if (PMS_REMOTE_URL == "" || WEN_UPLOAD_URL == "") {
		Win.alert({
			html: "缺少导播服务器配置，请联系管理员。",
			mask: true,
			width: 320
		}, 5000);							
	} else {
		director.init();
	}
	$('.exit').on('click', function () {
		Win.confirm({
			title: "提示",
			html: '确定要退出远程导播吗？',
			mask: true,
			width: 300
		}, function () {
			window.opener = null;
			window.open('', '_self', '');
			window.close();
		}, true);
	});
	function roomCenterPluginVersionCall(pluginVersion){
		var classType = "${classType}";
		if(pluginVersion.charAt(0)==5){//主课堂是5.0版本插件
			var redirectUrl = "";
			 if(classType == "ONLINE_CLASS"){
				 redirectUrl = ROOT+'/monitor/remote/${mid}.html?v=5';
			 } else {
				 redirectUrl = ROOT+'/monitor/remote/schoolNet/${mid}.html?v=5';
			 }
			 location.href = redirectUrl;
		}
	}
</script>
</body>
</html> 